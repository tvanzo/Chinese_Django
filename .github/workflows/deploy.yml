name: Deploy to Render

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DJANGO_SETTINGS_MODULE: ${{ secrets.DJANGO_SETTINGS_MODULE }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
      DEBUG: ${{ secrets.DEBUG }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
      DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
      DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: srv-cpoif12ju9rs738p174g

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure static dir exists
        run: mkdir -p myproject/static

      - name: Inspect subplayer migrations (before heal)
        run: |
          python manage.py showmigrations subplayer || true

      - name: Heal subplayer migration history (fake-apply 0003 if 0004 is already applied)
        shell: bash
        run: |
          set -e
          python manage.py showmigrations subplayer > .migs.txt || true
          NEED_0003=$(grep -E "^\s\[\s\]\s0003_placeholder" .migs.txt || true)
          HAS_0004=$(grep -E "^\s\[X\]\s0004_" .migs.txt || true)
          if [ -n "$NEED_0003" ] && [ -n "$HAS_0004" ]; then
            echo "0004 is applied but 0003 is not. Fake-applying 0003_placeholderâ€¦"
            python manage.py migrate subplayer 0003_placeholder --fake --noinput
          else
            echo "No heal needed."
          fi

      - name: Run migrations
        run: python manage.py migrate --noinput

      - name: Inspect subplayer migrations (after heal)
        run: python manage.py showmigrations subplayer

      - name: Create / ensure superuser
        shell: bash
        run: |
          python manage.py shell <<'PY'
          import os
          from django.contrib.auth import get_user_model
          User = get_user_model()
          username = os.environ["DJANGO_SUPERUSER_USERNAME"]
          email = os.environ.get("DJANGO_SUPERUSER_EMAIL", "")
          password = os.environ.get("DJANGO_SUPERUSER_PASSWORD")
          u, created = User.objects.get_or_create(username=username, defaults={"email": email})
          if created:
              u.is_superuser = True
              u.is_staff = True
              if password:
                  u.set_password(password)
              u.save()
              print("Superuser created.")
          else:
              changed = False
              if not u.is_superuser:
                  u.is_superuser = True; changed = True
              if not u.is_staff:
                  u.is_staff = True; changed = True
              if email and u.email != email:
                  u.email = email; changed = True
              if password:
                  u.set_password(password); changed = True
              if changed:
                  u.save()
                  print("Superuser updated.")
              else:
                  print("Superuser already correct.")
          PY

      - name: Collect static files
        run: python manage.py collectstatic --noinput

      - name: Trigger Render deploy
        run: |
          curl -s -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys
