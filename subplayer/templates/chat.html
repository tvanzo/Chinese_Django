{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- (Optional) keep consistent with your other pages -->
  <link rel="icon" type="image/svg+xml" href="{% static 'accounts/img/ele.png' %}">
  <title>AI Tutor Chat</title>

  <!-- Fonts & Icons (match the “good” template) -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="{% static 'accounts/css/nucleo-icons.css' %}" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="{% static 'accounts/css/nucleo-svg.css' %}" rel="stylesheet" />
  <link id="pagestyle" href="{% static 'accounts/css/soft-ui-dashboard.css' %}" rel="stylesheet" />

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: "Open Sans", sans-serif;
      background-color: #f8fafc;
      color: #111827;
    }

    /* =========================================================
       ✅ Chat page forces: mini sidebar + NO logo (sidebar + top nav)
       This is usually what causes “logo still shows”
       ========================================================= */
    @media (min-width: 769px) {
      /* force mini width */
      body.chat-page #sidenav-main {
        width: 72px !important;
        max-width: 72px !important;
        min-width: 72px !important;
      }
      body.chat-page .main-content {
        margin-left: 90px !important;
      }

      /* hide the sidenav brand/logo area completely */
      body.chat-page #sidenav-main .navbar-brand,
      body.chat-page #sidenav-main .navbar-brand-img,
      body.chat-page #sidenav-main .navbar-brand span,
      body.chat-page #sidenav-main .sidenav-header {
        display: none !important;
      }

      /* hide the “toggle” button that can expand sidebar (if you have one) */
      body.chat-page #sidebar-toggle-btn,
      body.chat-page .sidenav-toggler {
        display: none !important;
      }
    }

    /* If your TOP navbar has a logo you also want hidden on chat page */
    body.chat-page nav.navbar-main .navbar-brand,
    body.chat-page nav.navbar-main .navbar-brand-img,
    body.chat-page nav.navbar-main .navbar-brand span {
      display: none !important;
    }

    /* =========================================================
       Chat Layout
       ========================================================= */
    .chat-page-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 8px 18px;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .chat-shell {
      display: flex;
      height: 100%;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      overflow: hidden;
      min-height: 0;
      position: relative;
    }

    /* =========================================================
       Desktop Chat History (left column)
       ========================================================= */
    .chat-history {
      width: 290px;
      border-right: 1px solid #e5e7eb;
      background: #f7f7f8;
      display: flex;
      flex-direction: column;
      min-width: 0;
      transition: width 0.2s ease;
      position: relative;
      flex-shrink: 0;
      z-index: 2;
    }

    .chat-history-header {
      padding: 12px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-height: 52px;
    }

    .chat-history-title {
      font-size: 14px;
      font-weight: 800;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .new-chat-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background-color: #ffffff;
      border: 1px solid #e5e5e5;
      border-radius: 999px;
      font-weight: 800;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      font-size: 12px;
      color: #111827;
      white-space: nowrap;
    }

    .new-chat-btn:hover {
      background-color: #f1f1f1;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    .chat-history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      min-height: 0;
    }

    .chat-history-item {
      display: block;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      color: #111827;
      text-decoration: none;
      margin-bottom: 6px;
      background: transparent;
      transition: background 0.15s, box-shadow 0.15s;
      font-weight: 650;
    }

    .chat-history-item:hover { background: #e5e7eb; }

    .chat-history-item.active {
      background: #e8f3ff;
      font-weight: 900;
      box-shadow: inset 3px 0 0 #3a9fff;
    }

    .chat-history-empty {
      padding: 12px;
      font-size: 13px;
      color: #6b7280;
      font-weight: 650;
    }

    body.chat-history-collapsed .chat-history {
      width: 0px;
      border-right: none;
      overflow: hidden;
    }
    body.chat-history-collapsed .chat-history > * {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    /* =========================================================
       Chat Main
       ========================================================= */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      background: #ffffff;
      position: relative;
      z-index: 1;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 14px;
      border-bottom: 1px solid #e5e5e5;
      background-color: #f9fafb;
      min-height: 52px;
      gap: 10px;
    }

    .chat-title {
      font-weight: 900;
      font-size: 15px;
      color: #111827;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .round-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      color: #111827;
      transition: background 0.15s ease, box-shadow 0.15s ease;
      flex-shrink: 0;
    }
    .round-btn:hover {
      background: #f3f4f6;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
    }
    .round-btn svg { width: 18px; height: 18px; display: block; }

    .round-btn.active {
      border-color: #93c5fd;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.18);
    }

    /* Only show ONE desktop chat-history toggle */
    body:not(.chat-history-collapsed) #expandChatHistoryBtn { display: none !important; }
    body.chat-history-collapsed #collapseChatHistoryBtn { display: none !important; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scroll-behavior: smooth;
      background-color: #ffffff;
      min-height: 0;
    }

    .message-container {
      display: flex;
      padding: 18px 14px;
      border-bottom: 1px solid #f1f1f1;
      position: relative;
    }

    .message-container:hover .message-highlight-btn { opacity: 1; }

    .user-message-container { background-color: #ffffff; }
    .bot-message-container { background-color: #f7f7f8; }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background-color: #10a37f;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      margin-right: 12px;
      flex-shrink: 0;
      font-size: 12px;
    }

    .user-avatar { background-color: #3b82f6; }

    .message {
      flex: 1;
      line-height: 1.6;
      font-size: 15px;
      max-width: 100%;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      padding-right: 4px;
    }

    /* =========================================================
       ⭐ Highlight button for each message
       ========================================================= */
    .message-highlight-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s ease;
      opacity: 0;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .message-highlight-btn:hover {
      background: #fef3c7;
      color: #d97706;
      border-color: #fbbf24;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.25);
      transform: scale(1.05);
    }

    .message-highlight-btn.highlighted {
      opacity: 1;
      background: #fef3c7;
      color: #d97706;
      border-color: #fbbf24;
    }

    .message-highlight-btn svg { width: 16px; height: 16px; display: block; }

    @media (max-width: 768px) { .message-highlight-btn { opacity: 1; } }

    .tip {
      color: #6b7280;
      font-size: 12px;
      padding: 6px 14px 4px;
      border-top: 1px solid #f3f4f6;
      background-color: #fafafa;
      font-weight: 650;
    }

    .highlight-review-toggle {
      padding: 6px 14px 8px;
      background-color: #fafafa;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .review-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
      color: #111827;
      font-weight: 900;
      transition: background 0.15s, box-shadow 0.15s;
    }

    .review-btn:hover {
      background: #f3f4f6;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.1);
    }

    .input-container {
      border-top: 1px solid #e5e5e5;
      padding: 10px 14px 14px;
      position: relative;
      background-color: #f9fafb;
    }

    .input-inner {
      max-width: 920px;
      margin: 0 auto;
      width: 100%;
    }

    .input-box {
      display: flex;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 10px 12px;
      max-height: 200px;
      overflow-y: auto;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 15px;
      line-height: 1.5;
      resize: none;
      max-height: 150px;
      width: 100%;
      background: transparent;
    }

    .send-button {
      background-color: transparent;
      border: none;
      color: #3b82f6;
      cursor: pointer;
      padding: 6px 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }

    .send-button:disabled {
      color: #a0aec0;
      cursor: not-allowed;
    }

    .send-button svg { width: 18px; height: 18px; }

    .perm-highlight {
      background-color: rgba(255, 230, 0, 0.45);
      border-radius: 6px;
      padding: 0 2px;
    }

    .chat-message-text {
      position: relative;
      cursor: text;
      -webkit-user-select: text;
      user-select: text;
    }

    .chat-messages.highlight-mode {
      outline: 1px dashed #3b82f6;
      outline-offset: -4px;
    }

    /* =========================================================
       Highlight Review Panel (desktop floating)
       ========================================================= */
    .highlight-review-panel {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 320px;
      max-height: 60vh;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.25);
      border: 1px solid #e5e7eb;
      display: none;
      z-index: 2200;
      flex-direction: column;
      overflow: hidden;
    }

    .highlight-review-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 900;
      color: #111827;
      background: #f9fafb;
    }

    .review-close-btn {
      background: transparent;
      border: none;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      color: #6b7280;
    }

    .highlight-cards {
      padding: 8px 10px;
      overflow-y: auto;
      flex: 1;
    }

    .highlight-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #f9fafb;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-weight: 650;
    }

    .highlight-card input[type="checkbox"] { margin-top: 3px; flex-shrink: 0; }
    .highlight-card-text { white-space: pre-wrap; word-wrap: break-word; }

    .start-review-btn {
      margin: 6px 10px 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      background: #3b82f6;
      color: #ffffff;
      width: calc(100% - 20px);
    }
    .start-review-btn:hover { background: #2563eb; }

    /* =========================================================
       Mobile: Chat history drawer
       ========================================================= */
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.50);
      z-index: 3000;
      display: none;
    }
    .drawer-backdrop.open { display: block; }

    .drawer-panel {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 85vw;
      max-width: 360px;
      background: #f7f7f8;
      border-right: 1px solid #e5e7eb;
      z-index: 3001;
      transform: translateX(-100%);
      transition: transform 0.22s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .drawer-panel.open { transform: translateX(0); }

    .drawer-right-tap {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 15vw;
      z-index: 3002;
      display: none;
    }
    .drawer-right-tap.open { display: block; }

    .mobile-highlight-pill {
      display: none;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
      color: #111827;
      font-weight: 900;
      gap: 6px;
      align-items: center;
    }

    /* =========================================================
       Responsive rules
       ========================================================= */
    @media (max-width: 992px) {
      .chat-page-wrapper { padding: 10px 8px 12px; height: auto; }
      .highlight-review-panel { right: 8px; left: 8px; width: auto; }
    }

    @media (max-width: 768px) {
      .chat-page-wrapper { margin-left: 0 !important; padding: 8px; }
      .chat-shell { border-radius: 14px; }
      .chat-history { display: none !important; }
      #siteSidenavOpenBtn { display: inline-flex; }
      #openMobileDrawerBtn { display: inline-flex; }
      .mobile-highlight-pill { display: inline-flex; }
    }

    @media (min-width: 769px) {
      #siteSidenavOpenBtn,
      #openMobileDrawerBtn {
        display: none !important;
      }
    }

    /* =========================================================
       Categories footer + modal
       ========================================================= */
    .chat-history-categories-footer {
      border-top: 1px solid #e5e5e5;
      padding: 10px 10px 12px;
      background: #f7f7f8;
    }

    .chat-history-categories-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .chat-history-categories-label {
      font-size: 12px;
      font-weight: 900;
      color: #374151;
    }

    .chat-history-add-category-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      color: #111827;
      white-space: nowrap;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }

    .chat-history-add-category-btn:hover {
      background: #f3f4f6;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    .chat-history-categories-scroll {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }

    .chat-history-categories-scroll::-webkit-scrollbar { height: 6px; }
    .chat-history-categories-scroll::-webkit-scrollbar-thumb {
      background: rgba(17, 24, 39, 0.16);
      border-radius: 999px;
    }

    .chat-category-chip {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      text-decoration: none;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
      transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      font-weight: 800;
    }

    .chat-category-chip:hover {
      background: #f3f4f6;
      box-shadow: 0 1px 6px rgba(15, 23, 42, 0.10);
    }

    .chat-category-chip.active {
      background: #e8f3ff;
      border-color: #93c5fd;
      box-shadow: inset 0 0 0 1px #93c5fd;
      font-weight: 950;
    }

    .chat-category-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.50);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      padding: 16px;
    }

    .chat-category-modal {
      width: 420px;
      max-width: 100%;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .chat-category-modal-header {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .chat-category-modal-title {
      font-size: 13px;
      font-weight: 950;
      color: #111827;
    }

    .chat-category-modal-close {
      background: transparent;
      border: none;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      color: #6b7280;
    }

    .chat-category-modal-body { padding: 14px; }

    .chat-category-modal-label {
      font-size: 12px;
      font-weight: 950;
      color: #374151;
      margin-bottom: 6px;
      display: block;
    }

    .chat-category-modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      outline: none;
      font-size: 14px;
    }

    .chat-category-modal-input:focus {
      border-color: #93c5fd;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .chat-category-modal-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      font-weight: 650;
    }

    .chat-category-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 12px 14px 14px;
      border-top: 1px solid #e5e7eb;
    }

    .chat-category-btn-secondary {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 900;
    }

    .chat-category-btn-primary {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: #3b82f6;
      color: #ffffff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 950;
    }

    .chat-category-btn-primary:hover { background: #2563eb; }

    /* =========================================================
       Sitewide sidebar mobile overlay helpers (if your sidebar.html uses these)
       ========================================================= */
    .site-sidenav-backdrop,
    .site-sidenav-righttap { display: none; }

    body.site-sidenav-open .site-sidenav-backdrop {
      display: block;
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.50);
      z-index: 2999;
    }

    body.site-sidenav-open #sidenav-main {
      transform: translateX(0) !important;
    }

    body.site-sidenav-open .site-sidenav-righttap {
      display: block;
      position: fixed;
      top: 0;
      right: 0;
      width: 15vw;
      height: 100vh;
      z-index: 3005;
    }

    @media (max-width: 768px) {
      /* On mobile, keep sidebar off-canvas unless opened */
      #sidenav-main {
        transform: translateX(-110%) !important;
        transition: transform 0.22s ease !important;
        z-index: 3004 !important;
      }
      body.site-sidenav-open #sidenav-main {
        transform: translateX(0) !important;
      }
    }
    /* =========================================================
   Chat page: make Soft UI sidebar look like other pages
   (white card, border, shadow) + keep mini width on desktop
   Copy/paste this whole block into your chat template <style>
   ========================================================= */

/* --- 1) Restore the Soft UI “card” look on the site sidebar --- */
body.chat-page #sidenav-main {
  background: #ffffff !important;
  border: 1px solid rgba(0, 0, 0, 0.08) !important;
  border-radius: 16px !important;
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08) !important;

  /* mimic Soft UI spacing (my-3 ms-3) */
  margin: 12px 0 12px 12px !important;
}

/* Make sure no global/other rules force transparent backgrounds */
body.chat-page .sidenav,
body.chat-page aside,
body.chat-page #sidenav-main.sidenav {
  background: transparent;
}

/* Optional: if your sidenav is “fixed-start”, ensure it stays visible */
body.chat-page #sidenav-main.fixed-start {
  top: 0 !important;
  height: calc(100vh - 24px) !important; /* account for 12px top/bottom margin */
}

/* --- 2) Keep chat page sidebar collapsed on desktop (mini mode) --- */
@media (min-width: 769px) {
  body.chat-page #sidenav-main {
    width: 72px !important;
    min-width: 72px !important;
    max-width: 72px !important;
  }

  /* Keep main content aligned with mini sidebar */
  body.chat-page .main-content {
    margin-left: 90px !important;
  }

  /* Hide the collapse toggle so users can’t expand it on chat page */
  body.chat-page #sidebar-toggle-btn {
    display: none !important;
  }

  /* If Soft UI shows brand/logo block inside sidenav, hide it */
  body.chat-page #sidenav-main .navbar-brand,
  body.chat-page #sidenav-main .sidenav-header,
  body.chat-page #sidenav-main .brand-logo,
  body.chat-page #sidenav-main .navbar-brand-img,
  body.chat-page #sidenav-main .navbar-brand span {
    display: none !important;
  }

  /* Center nav icons nicely in mini mode */
  body.chat-page #sidenav-main .navbar-nav .nav-link {
    justify-content: center !important;
    padding-left: 0.75rem !important;
    padding-right: 0.75rem !important;
  }

  /* Hide link text in mini mode */
  body.chat-page #sidenav-main .nav-link-text,
  body.chat-page #sidenav-main .sidenav-normal,
  body.chat-page #sidenav-main .sidenav-mini-icon + span {
    display: none !important;
  }

  /* Give icons a consistent size/feel */
  body.chat-page #sidenav-main .icon {
    margin-right: 0 !important;
  }
}

/* --- 3) Mobile behavior: use your drawer, don’t force mini card styles --- */
@media (max-width: 768px) {
  body.chat-page #sidenav-main {
    margin: 0 !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    border: none !important;
  }
}

/* =========================================================
   END Chat page sidebar fixes
   ========================================================= */

  </style>
</head>

<body class="g-sidenav-show bg-gray-100 chat-page">
  {% include 'accounts/navbar.html' %}
  {% include 'accounts/sidebar.html' %}

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <div class="chat-page-wrapper">
      <div class="chat-shell">

        <!-- Desktop Chat History -->
        <aside class="chat-history" id="chatHistory">
          <div class="chat-history-header">
            <div class="chat-history-title">Chats</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="round-btn" id="collapseChatHistoryBtn" aria-label="Collapse chat list" title="Collapse" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M15 18l-6-6 6-6"></path>
                </svg>
              </button>

              <button class="new-chat-btn" id="newChatBtn" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                     viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New chat
              </button>
            </div>
          </div>

          <div class="chat-history-list">
            {% if sessions %}
              {% for s in sessions %}
                <a href="/chat/?session={{ s.id }}"
                   class="chat-history-item {% if current_session.id == s.id %}active{% endif %}">
                  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                      {{ s.title|default:"Untitled chat" }}
                    </span>
                    {% if s.highlight_count %}
                      <span style="font-size:12px; color:#6b7280; flex-shrink:0; font-weight:800;">
                        ★ {{ s.highlight_count }}
                      </span>
                    {% endif %}
                  </div>
                </a>
              {% endfor %}
            {% else %}
              <div class="chat-history-empty">No chats yet. Start a new one!</div>
            {% endif %}
          </div>

          <!-- Categories footer -->
          <div class="chat-history-categories-footer">
            <div class="chat-history-categories-top">
              <span class="chat-history-categories-label">Categories</span>
              <button type="button" class="chat-history-add-category-btn" id="addCategoryBtn" aria-label="Add category" title="Add category">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 5v14M5 12h14"></path>
                </svg>
                <span>Add</span>
              </button>
            </div>

            <div class="chat-history-categories-scroll" id="categoryScroll">
              <a class="chat-category-chip {% if not selected_category %}active{% endif %}"
                 href="/chat/?{% if current_session %}session={{ current_session.id }}&{% endif %}">
                All
              </a>

              {% if categories %}
                {% for c in categories %}
                  <a class="chat-category-chip {% if selected_category|stringformat:'s' == c.id|stringformat:'s' %}active{% endif %}"
                     href="/chat/?{% if current_session %}session={{ current_session.id }}&{% endif %}category={{ c.id }}">
                    {{ c.name }}
                  </a>
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </aside>

        <!-- Chat Main -->
        <section class="chat-main">
          <div class="chat-header">
            <!-- Mobile: open SITEWIDE sidebar drawer -->
            <button class="round-btn" id="siteSidenavOpenBtn" aria-label="Open menu" title="Menu" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M16 8l-2 8-8 2 2-8 8-2z"></path>
              </svg>
            </button>

            <!-- Mobile: open CHAT HISTORY drawer -->
            <button class="round-btn" id="openMobileDrawerBtn" aria-label="Open chats" title="Chats" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>

            <!-- Desktop: collapse/expand chat history -->
            <button class="round-btn" id="expandChatHistoryBtn" aria-label="Toggle chat list" title="Chats" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M8 6h13M8 12h13M8 18h13"></path>
                <path d="M3 6h.01M3 12h.01M3 18h.01"></path>
              </svg>
            </button>

            <div class="chat-title">
              {{ current_session.title|default:"AI Tutor Chat" }}
            </div>

            <!-- Translate toggle -->
            <button class="round-btn" id="toggleTranslateBtn" aria-label="Toggle translate mode" title="Translate mode" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M4 19h6"></path>
                <path d="M7 19V5h3"></path>
                <path d="M14 7h6"></path>
                <path d="M17 7v12"></path>
              </svg>
            </button>
          </div>

          <div class="chat-messages" id="chatMessages">
            {% if messages %}
              {% for m in messages %}
                <div class="message-container {% if m.role == 'user' %}user-message-container{% else %}bot-message-container{% endif %}" data-message-id="{{ m.id }}">
                  <div class="avatar {% if m.role == 'user' %}user-avatar{% endif %}">
                    {% if m.role == 'user' %}You{% else %}AI{% endif %}
                  </div>
                  <div class="message {% if m.role == 'user' %}user-message{% else %}bot-message{% endif %} chat-message-text">
                    {{ m.content }}
                  </div>
                  {% if m.role != 'user' %}
                    <button class="message-highlight-btn" data-message-id="{{ m.id }}" aria-label="Highlight this response" title="Highlight this response" type="button">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                      </svg>
                    </button>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <div class="message-container bot-message-container">
                <div class="avatar">AI</div>
                <div class="message bot-message chat-message-text">
                  Hi there! I'm your AI tutor. How can I help you today?
                </div>
              </div>
            {% endif %}
          </div>

          <div class="tip">
            Press Enter to send • Shift+Enter for a new line • <strong>Click ⭐ to highlight a response</strong>
            • <strong>Press Shift on a selection to highlight (or on a yellow highlight to remove)</strong>
          </div>

          <div class="highlight-review-toggle">
            <button id="reviewHighlightsBtn" class="review-btn" type="button">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 11l6 6"></path>
                <path d="M11 9l4 4"></path>
                <path d="M3 21l3-3"></path>
                <path d="M14 4l6 6"></path>
                <path d="M4 14l6 6"></path>
              </svg>
              Review highlights
            </button>

            <button id="highlightSelectionPill" class="mobile-highlight-pill" type="button">
              ⭐ Highlight selection
            </button>
          </div>

          <div class="input-container">
            <div class="input-inner">
              <div class="input-box">
                <textarea id="userInput"
                          class="chat-input"
                          placeholder="Message your AI tutor..."
                          rows="1"></textarea>
                <button id="sendButton" class="send-button" disabled type="button" aria-label="Send">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       viewBox="0 0 24 24"
                       fill="currentColor">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- Desktop review panel -->
  <div id="highlightReviewPanel" class="highlight-review-panel">
    <div class="highlight-review-header">
      <span>Highlight review</span>
      <button id="closeReviewBtn" class="review-close-btn" type="button">&times;</button>
    </div>
    <div id="highlightCards" class="highlight-cards"></div>
    <button id="startReviewBtn" class="start-review-btn" type="button">
      Ask tutor about selected
    </button>
  </div>

  <!-- Categories modal -->
  <div class="chat-category-modal-backdrop" id="categoryModalBackdrop" aria-hidden="true">
    <div class="chat-category-modal" role="dialog" aria-modal="true" aria-labelledby="categoryModalTitle">
      <div class="chat-category-modal-header">
        <div class="chat-category-modal-title" id="categoryModalTitle">Create category</div>
        <button class="chat-category-modal-close" id="closeCategoryModalBtn" type="button" aria-label="Close">&times;</button>
      </div>

      <div class="chat-category-modal-body">
        <label class="chat-category-modal-label" for="categoryNameInput">Category name</label>
        <input class="chat-category-modal-input" id="categoryNameInput" type="text"
               placeholder="e.g. Daily Journal, HSK 6, AI" maxlength="60" />
        <div class="chat-category-modal-hint">Keep it short. You can add more later.</div>
      </div>

      <div class="chat-category-modal-actions">
        <button class="chat-category-btn-secondary" id="cancelCategoryBtn" type="button">Cancel</button>
        <button class="chat-category-btn-primary" id="createCategoryBtn" type="button">Create</button>
      </div>
    </div>
  </div>

  <!-- Mobile Drawer (Chat history) -->
  <div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
  <div id="drawerPanel" class="drawer-panel" aria-hidden="true">
    <div class="chat-history-header" style="border-bottom: 1px solid #e5e5e5;">
      <div class="chat-history-title">Chats</div>
      <button class="new-chat-btn" id="newChatBtnMobile" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New chat
      </button>
    </div>

    <div class="chat-history-list" id="mobileChatList">
      {% if sessions %}
        {% for s in sessions %}
          <a href="/chat/?session={{ s.id }}"
             class="chat-history-item {% if current_session.id == s.id %}active{% endif %}">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                {{ s.title|default:"Untitled chat" }}
              </span>
              {% if s.highlight_count %}
                <span style="font-size:12px; color:#6b7280; flex-shrink:0; font-weight:800;">
                  ★ {{ s.highlight_count }}
                </span>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="chat-history-empty">No chats yet. Start a new one!</div>
      {% endif %}
    </div>

    <div class="chat-history-categories-footer">
      <div class="chat-history-categories-top">
        <span class="chat-history-categories-label">Categories</span>
        <button type="button" class="chat-history-add-category-btn" id="addCategoryBtnMobile" aria-label="Add category" title="Add category">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          <span>Add</span>
        </button>
      </div>

      <div class="chat-history-categories-scroll">
        <a class="chat-category-chip {% if not selected_category %}active{% endif %}"
           href="/chat/?{% if current_session %}session={{ current_session.id }}&{% endif %}">
          All
        </a>

        {% if categories %}
          {% for c in categories %}
            <a class="chat-category-chip {% if selected_category|stringformat:'s' == c.id|stringformat:'s' %}active{% endif %}"
               href="/chat/?{% if current_session %}session={{ current_session.id }}&{% endif %}category={{ c.id }}">
              {{ c.name }}
            </a>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>

  <div id="drawerRightTap" class="drawer-right-tap" aria-hidden="true"></div>

  <!-- Sitewide sidebar mobile overlay -->
  <div class="site-sidenav-backdrop" id="siteSidenavBackdrop" aria-hidden="true"></div>
  <div class="site-sidenav-righttap" id="siteSidenavRightTap" aria-hidden="true"></div>

  <!-- =========================================================
       ✅ Soft UI JS (THIS IS IMPORTANT to match your “good” template)
       ========================================================= -->
  <script src="{% static 'accounts/js/core/popper.min.js' %}"></script>
  <script src="{% static 'accounts/js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'accounts/js/plugins/perfect-scrollbar.min.js' %}"></script>
  <script src="{% static 'accounts/js/plugins/smooth-scrollbar.min.js' %}"></script>
  <script src="{% static 'accounts/js/soft-ui-dashboard.min.js?v=1.0.7' %}"></script>

  <script>
    // Soft UI scrollbar init (same pattern as your good page)
    (function () {
      var win = navigator.platform.indexOf('Win') > -1;
      if (win && document.querySelector('#sidenav-scrollbar')) {
        var options = { damping: '0.5' };
        Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
      }
    })();
  </script>

  <script>
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");

    const newChatBtn = document.getElementById("newChatBtn");
    const newChatBtnMobile = document.getElementById("newChatBtnMobile");

    const reviewHighlightsBtn = document.getElementById("reviewHighlightsBtn");
    const reviewPanel = document.getElementById("highlightReviewPanel");
    const closeReviewBtn = document.getElementById("closeReviewBtn");
    const highlightCardsEl = document.getElementById("highlightCards");
    const startReviewBtn = document.getElementById("startReviewBtn");

    const collapseChatHistoryBtn = document.getElementById("collapseChatHistoryBtn");
    const expandChatHistoryBtn = document.getElementById("expandChatHistoryBtn");

    /* Chat history mobile drawer */
    const openMobileDrawerBtn = document.getElementById("openMobileDrawerBtn");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const drawerPanel = document.getElementById("drawerPanel");
    const drawerRightTap = document.getElementById("drawerRightTap");

    /* Sitewide sidebar mobile drawer */
    const siteSidenavOpenBtn = document.getElementById("siteSidenavOpenBtn");
    const siteSidenavBackdrop = document.getElementById("siteSidenavBackdrop");
    const siteSidenavRightTap = document.getElementById("siteSidenavRightTap");

    /* Mobile highlight pill */
    const highlightSelectionPill = document.getElementById("highlightSelectionPill");

    /* Translate toggle */
    const toggleTranslateBtn = document.getElementById("toggleTranslateBtn");
    let translateMode = false;

    function setTranslateMode(on) {
      translateMode = !!on;
      if (toggleTranslateBtn) toggleTranslateBtn.classList.toggle("active", translateMode);

      userInput.placeholder = translateMode
        ? "Translate: paste text here…"
        : "Message your AI tutor...";

      try { localStorage.setItem("translateMode", translateMode ? "1" : "0"); } catch (e) {}
    }

    function loadTranslateMode() {
      let on = false;
      try { on = localStorage.getItem("translateMode") === "1"; } catch (e) {}
      setTranslateMode(on);
    }

    if (toggleTranslateBtn) {
      toggleTranslateBtn.addEventListener("click", () => setTranslateMode(!translateMode));
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const CSRF_TOKEN = getCookie("csrftoken");

    function isMobile() {
      return window.matchMedia("(max-width: 768px)").matches;
    }

    /* Desktop chat history collapse (localStorage) */
    function setChatHistoryCollapsed(collapsed) {
      if (collapsed) document.body.classList.add("chat-history-collapsed");
      else document.body.classList.remove("chat-history-collapsed");
      try { localStorage.setItem("chatHistoryCollapsed", collapsed ? "1" : "0"); } catch (e) {}
    }

    function loadChatHistoryCollapsed() {
      let collapsed = false;
      try { collapsed = localStorage.getItem("chatHistoryCollapsed") === "1"; } catch (e) {}
      setChatHistoryCollapsed(collapsed);
    }

    function toggleChatHistory() {
      const collapsed = document.body.classList.contains("chat-history-collapsed");
      setChatHistoryCollapsed(!collapsed);
    }

    if (collapseChatHistoryBtn) collapseChatHistoryBtn.addEventListener("click", toggleChatHistory);
    if (expandChatHistoryBtn) expandChatHistoryBtn.addEventListener("click", toggleChatHistory);

    /* Mobile chat history drawer */
    function openDrawer() {
      if (!isMobile()) return;
      drawerBackdrop.classList.add("open");
      drawerPanel.classList.add("open");
      drawerRightTap.classList.add("open");
      drawerBackdrop.setAttribute("aria-hidden", "false");
      drawerPanel.setAttribute("aria-hidden", "false");
      drawerRightTap.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeDrawer() {
      drawerBackdrop.classList.remove("open");
      drawerPanel.classList.remove("open");
      drawerRightTap.classList.remove("open");
      drawerBackdrop.setAttribute("aria-hidden", "true");
      drawerPanel.setAttribute("aria-hidden", "true");
      drawerRightTap.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    if (openMobileDrawerBtn) openMobileDrawerBtn.addEventListener("click", openDrawer);
    if (drawerBackdrop) drawerBackdrop.addEventListener("click", closeDrawer);
    if (drawerRightTap) drawerRightTap.addEventListener("click", closeDrawer);

    if (drawerPanel) {
      drawerPanel.addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (a) closeDrawer();
      });
    }

    /* Mobile SITEWIDE sidebar drawer open/close */
    function openSiteSidenav() {
      if (!isMobile()) return;
      document.body.classList.add("site-sidenav-open");
      document.body.style.overflow = "hidden";
    }

    function closeSiteSidenav() {
      document.body.classList.remove("site-sidenav-open");
      document.body.style.overflow = "";
    }

    if (siteSidenavOpenBtn) siteSidenavOpenBtn.addEventListener("click", openSiteSidenav);
    if (siteSidenavBackdrop) siteSidenavBackdrop.addEventListener("click", closeSiteSidenav);
    if (siteSidenavRightTap) siteSidenavRightTap.addEventListener("click", closeSiteSidenav);

    document.addEventListener("click", (e) => {
      if (!isMobile()) return;
      if (!document.body.classList.contains("site-sidenav-open")) return;

      const sidenav = document.getElementById("sidenav-main");
      const a = e.target.closest("a");
      if (a && sidenav && sidenav.contains(a)) closeSiteSidenav();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      closeDrawer();
      closeSiteSidenav();
      if (reviewPanel) reviewPanel.style.display = "none";
    });

    window.addEventListener("resize", () => {
      if (!isMobile()) {
        closeDrawer();
        closeSiteSidenav();
      }
    });

    /* New chat buttons */
    function goNewChat() {
      window.location.href = "/chat/?new=1";
    }
    if (newChatBtn) newChatBtn.addEventListener("click", goNewChat);
    if (newChatBtnMobile) newChatBtnMobile.addEventListener("click", goNewChat);

    /* Input behavior */
    userInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
      sendButton.disabled = !this.value.trim();
    });

    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendButton.addEventListener("click", sendMessage);

    /* =========================================================
       ✅ HIGHLIGHTS STATE (FIXED)
       ========================================================= */
    let allHighlights = [];
    let selectionHighlights = [];

    const messageHighlightIdByMessageId = new Map(); // msgId(string) -> highlightId(string)
    const messageHighlightedIds = new Set();          // msgId(string)

    async function fetchAllHighlights() {
      try {
        const res = await fetch("/chat/api/highlights/?session={{ current_session.id }}", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });
        if (!res.ok) return;

        const data = await res.json();
        allHighlights = Array.isArray(data) ? data : [];

        messageHighlightIdByMessageId.clear();
        messageHighlightedIds.clear();
        selectionHighlights = [];

        allHighlights.forEach(h => {
          if (!h) return;
          if (h.message_id) {
            const mid = String(h.message_id);
            messageHighlightedIds.add(mid);
            if (h.id != null) messageHighlightIdByMessageId.set(mid, String(h.id));
          } else if (h.text) {
            selectionHighlights.push(h);
          }
        });

        updateHighlightButtons();
        applyAllChatHighlights();
      } catch (e) {
        console.error("Error fetching highlights:", e);
      }
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function applyHighlightsToElement(el) {
      const originalText = el.textContent;
      if (!originalText) return;

      const sorted = [...selectionHighlights].sort((a, b) => (b.text || "").length - (a.text || "").length);
      let html = originalText;

      sorted.forEach((h) => {
        if (!h.text || h.id == null) return;
        const safe = escapeRegExp(h.text);
        const re = new RegExp(safe, "g");
        html = html.replace(
          re,
          `<span class="perm-highlight" data-highlight-id="${String(h.id)}">$&</span>`
        );
      });

      el.innerHTML = html;
    }

    function applyAllChatHighlights() {
      const messageEls = chatMessages.querySelectorAll(".chat-message-text");
      messageEls.forEach((el) => applyHighlightsToElement(el));
    }

    function appendMessage({ role, text, messageId }) {
      const container = document.createElement("div");
      container.className =
        "message-container " +
        (role === "user" ? "user-message-container" : "bot-message-container");

      if (messageId) container.setAttribute("data-message-id", messageId);

      const avatar = document.createElement("div");
      avatar.className = "avatar " + (role === "user" ? "user-avatar" : "");
      avatar.textContent = role === "user" ? "You" : "AI";

      const msg = document.createElement("div");
      msg.className =
        "message " +
        (role === "user" ? "user-message" : "bot-message") +
        " chat-message-text";
      msg.textContent = text;

      container.appendChild(avatar);
      container.appendChild(msg);

      if (role !== "user") {
        const highlightBtn = document.createElement("button");
        highlightBtn.className = "message-highlight-btn";
        highlightBtn.type = "button";
        highlightBtn.setAttribute("aria-label", "Highlight this response");
        highlightBtn.setAttribute("title", "Highlight this response");
        if (messageId) highlightBtn.setAttribute("data-message-id", messageId);
        highlightBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
        `;
        container.appendChild(highlightBtn);

        highlightBtn.addEventListener("click", handleMessageHighlight);

        if (messageId && messageHighlightedIds.has(String(messageId))) {
          highlightBtn.classList.add("highlighted");
        }
      }

      chatMessages.appendChild(container);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      applyHighlightsToElement(msg);
    }

    function showTyping() {
      const typing = document.createElement("div");
      typing.className = "message-container bot-message-container";
      typing.id = "typingIndicator";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = "AI";

      const msg = document.createElement("div");
      msg.className = "message bot-message chat-message-text";
      msg.textContent = translateMode ? "Translating..." : "Typing...";

      typing.appendChild(avatar);
      typing.appendChild(msg);
      chatMessages.appendChild(typing);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById("typingIndicator");
      if (el) el.remove();
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      userInput.value = "";
      userInput.style.height = "auto";
      sendButton.disabled = true;

      await sendMessageWithCustomPayload(message, null);
    }

    async function sendMessageWithCustomPayload(message, mode) {
      appendMessage({ role: "user", text: message });
      showTyping();

      try {
        const res = await fetch("/chat/api/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN,
          },
          body: JSON.stringify({
            message,
            mode: mode || (translateMode ? "translate" : "normal"),
            target: "english",
            session_id: {{ current_session.id }},
          }),
        });

        const data = await res.json();
        hideTyping();

        if (!res.ok) {
          appendMessage({
            role: "bot",
            text: data.error || "Something went wrong. Please try again.",
          });
        } else {
          appendMessage({
            role: "bot",
            text: data.reply || "(No response)",
            messageId: data.message_id
          });
        }
      } catch (err) {
        hideTyping();
        appendMessage({
          role: "bot",
          text: "Network error. Please try again.",
        });
      } finally {
        userInput.focus();
      }
    }

    userInput.focus();

    /* Message-level highlights */
    function updateHighlightButtons() {
      const allBtns = document.querySelectorAll(".message-highlight-btn");
      allBtns.forEach(btn => {
        const msgId = btn.getAttribute("data-message-id");
        if (msgId && messageHighlightedIds.has(String(msgId))) {
          btn.classList.add("highlighted");
          btn.setAttribute("title", "Remove highlight");
        } else {
          btn.classList.remove("highlighted");
          btn.setAttribute("title", "Highlight this response");
        }
      });
    }

    async function createMessageHighlight(messageId, text) {
      try {
        const res = await fetch("/chat/api/highlights/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN,
          },
          body: JSON.stringify({
            session_id: {{ current_session.id }},
            message_id: messageId,
            text: (text || "").trim()
          }),
        });

        const data = await res.json();

        if (!res.ok) {
          if (data && data.limit_reached) {
            alert("You've reached your daily highlight limit (3 for free users). Upgrade for unlimited!");
          } else {
            console.error("Highlight creation failed:", data);
            alert("Failed to save highlight. Please try again.");
          }
          return null;
        }

        if (data && data.id != null) {
          messageHighlightIdByMessageId.set(String(messageId), String(data.id));
          messageHighlightedIds.add(String(messageId));
        }

        allHighlights.push(data);
        return data;

      } catch (e) {
        console.error("Network error creating highlight:", e);
        alert("Network error. Please check your connection.");
        return null;
      }
    }

    async function removeMessageHighlight(messageId) {
      try {
        const hid = messageHighlightIdByMessageId.get(String(messageId));
        if (!hid) return false;

        const res = await fetch(`/chat/api/highlights/${hid}/`, {
          method: "DELETE",
          headers: { "X-CSRFToken": CSRF_TOKEN },
        });

        if (!res.ok) return false;

        messageHighlightIdByMessageId.delete(String(messageId));
        messageHighlightedIds.delete(String(messageId));
        allHighlights = allHighlights.filter(h => String(h.id) !== String(hid));
        return true;
      } catch (e) {
        console.error("Remove message highlight failed:", e);
        return false;
      }
    }

    async function handleMessageHighlight(e) {
      const btn = e.currentTarget;
      const messageId = btn.getAttribute("data-message-id");
      const container = btn.closest(".message-container");
      const messageEl = container?.querySelector(".chat-message-text");
      if (!messageId || !messageEl) return;

      const isHighlighted = messageHighlightedIds.has(String(messageId));

      if (isHighlighted) {
        const success = await removeMessageHighlight(messageId);
        if (success) btn.classList.remove("highlighted");
      } else {
        const text = messageEl.textContent.trim();
        const created = await createMessageHighlight(messageId, text);
        if (created) btn.classList.add("highlighted");
      }

      updateHighlightButtons();
    }

    document.querySelectorAll(".message-highlight-btn").forEach(btn => {
      btn.addEventListener("click", handleMessageHighlight);
    });

    /* Selection highlights */
    async function createChatHighlight(text) {
      try {
        const res = await fetch("/chat/api/highlights/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN,
          },
          body: JSON.stringify({
            session_id: {{ current_session.id }},
            text
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          if (data && data.limit_reached) {
            alert("You've reached your daily highlight limit (3 for free users). Upgrade for unlimited!");
          }
          return null;
        }

        allHighlights.push(data);
        if (!data.message_id) selectionHighlights.push(data);
        return data;
      } catch (e) {
        console.error("Create selection highlight failed:", e);
        return null;
      }
    }

    async function deleteHighlightById(highlightId) {
      try {
        const res = await fetch(`/chat/api/highlights/${highlightId}/`, {
          method: "DELETE",
          headers: { "X-CSRFToken": CSRF_TOKEN },
        });
        if (!res.ok) return false;

        await fetchAllHighlights();
        return true;
      } catch (e) {
        console.error("Delete highlight failed:", e);
        return false;
      }
    }

    function findNearestHighlightSpan(node) {
      if (!node) return null;
      let el = (node.nodeType === Node.ELEMENT_NODE) ? node : node.parentElement;
      while (el && el !== document.body) {
        if (el.classList && el.classList.contains("perm-highlight") && el.dataset.highlightId) {
          return el;
        }
        el = el.parentElement;
      }
      return null;
    }

    async function highlightSelectionCreate() {
      const selection = window.getSelection();
      if (!selection || !selection.rangeCount) return;

      const text = selection.toString().trim();
      if (!text) return;

      const range = selection.getRangeAt(0);
      if (!chatMessages.contains(range.commonAncestorContainer)) return;

      const saved = await createChatHighlight(text);
      if (!saved) return;

      const span = document.createElement("span");
      span.className = "perm-highlight";
      span.setAttribute("data-highlight-id", String(saved.id));
      span.textContent = text;

      try {
        range.deleteContents();
        range.insertNode(span);
      } catch (e) {
        applyAllChatHighlights();
      }

      selection.removeAllRanges();
    }

    async function highlightSelectionRemoveIfInside() {
      const selection = window.getSelection();
      if (!selection || !selection.rangeCount) return false;

      const range = selection.getRangeAt(0);
      if (!range) return false;

      const anchorNode = selection.anchorNode;
      if (!chatMessages.contains(anchorNode)) return false;

      const span = findNearestHighlightSpan(anchorNode);
      if (!span) return false;

      const hid = span.dataset.highlightId;
      if (!hid) return false;

      try { selection.removeAllRanges(); } catch (e) {}

      const ok = await deleteHighlightById(hid);
      return ok;
    }

    document.addEventListener("keydown", async function (e) {
      if (e.key !== "Shift") return;

      const removed = await highlightSelectionRemoveIfInside();
      if (removed) return;

      await highlightSelectionCreate();
    });

    if (highlightSelectionPill) {
      highlightSelectionPill.addEventListener("click", highlightSelectionCreate);
    }

    chatMessages.addEventListener("mousedown", () => {
      chatMessages.classList.add("highlight-mode");
    });
    document.addEventListener("mouseup", () => {
      chatMessages.classList.remove("highlight-mode");
    });

    /* Review Panel */
    function renderHighlightCards() {
      highlightCardsEl.innerHTML = "";

      if (!allHighlights.length) {
        const empty = document.createElement("div");
        empty.className = "chat-history-empty";
        empty.textContent = "No highlights yet. Click the ⭐ button on any AI response, or select text and press Shift.";
        highlightCardsEl.appendChild(empty);
        return;
      }

      allHighlights.forEach((h, idx) => {
        const card = document.createElement("div");
        card.className = "highlight-card";
        const prefix = h && h.message_id ? "★ " : "";
        const text = (h && h.text) ? h.text : "";
        card.innerHTML = `
          <input type="checkbox" value="${idx}" />
          <div class="highlight-card-text">${prefix}${text}</div>
        `;
        highlightCardsEl.appendChild(card);
      });
    }

    if (reviewHighlightsBtn) {
      reviewHighlightsBtn.addEventListener("click", () => {
        renderHighlightCards();
        reviewPanel.style.display = "flex";
      });
    }

    if (closeReviewBtn) closeReviewBtn.addEventListener("click", () => {
      reviewPanel.style.display = "none";
    });

    if (startReviewBtn) startReviewBtn.addEventListener("click", () => {
      const checked = Array.from(highlightCardsEl.querySelectorAll('input[type="checkbox"]:checked'));
      if (!checked.length) {
        reviewPanel.style.display = "none";
        return;
      }

      const texts = checked.map((input) => {
        const idx = parseInt(input.value, 10);
        return allHighlights[idx].text;
      });

      const combined = texts.map((t, i) => `${i + 1}. ${t}`).join("\n");

      const prompt =
        "Here are some Chinese snippets I have highlighted before:\n\n" +
        combined +
        "\n\nPlease help me REVIEW them: create a short quiz, example sentences, and quick explanations with characters, pinyin, and brief English.";

      reviewPanel.style.display = "none";
      sendMessageWithCustomPayload(prompt, "review");
    });

    /* Categories modal + create */
    (function () {
      const addCategoryBtn = document.getElementById("addCategoryBtn");
      const addCategoryBtnMobile = document.getElementById("addCategoryBtnMobile");
      const categoryModalBackdrop = document.getElementById("categoryModalBackdrop");
      const closeCategoryModalBtn = document.getElementById("closeCategoryModalBtn");
      const cancelCategoryBtn = document.getElementById("cancelCategoryBtn");
      const createCategoryBtn = document.getElementById("createCategoryBtn");
      const categoryNameInput = document.getElementById("categoryNameInput");

      if (!categoryModalBackdrop) return;

      function openCategoryModal() {
        categoryModalBackdrop.style.display = "flex";
        categoryModalBackdrop.setAttribute("aria-hidden", "false");
        setTimeout(() => categoryNameInput && categoryNameInput.focus(), 0);
      }

      function closeCategoryModal() {
        categoryModalBackdrop.style.display = "none";
        categoryModalBackdrop.setAttribute("aria-hidden", "true");
        if (categoryNameInput) categoryNameInput.value = "";
      }

      if (addCategoryBtn) addCategoryBtn.addEventListener("click", openCategoryModal);
      if (addCategoryBtnMobile) addCategoryBtnMobile.addEventListener("click", () => {
        closeDrawer();
        openCategoryModal();
      });

      if (closeCategoryModalBtn) closeCategoryModalBtn.addEventListener("click", closeCategoryModal);
      if (cancelCategoryBtn) cancelCategoryBtn.addEventListener("click", closeCategoryModal);

      categoryModalBackdrop.addEventListener("click", (e) => {
        if (e.target === categoryModalBackdrop) closeCategoryModal();
      });

      if (categoryNameInput) {
        categoryNameInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            if (createCategoryBtn) createCategoryBtn.click();
          }
        });
      }

      if (createCategoryBtn) {
        createCategoryBtn.addEventListener("click", async () => {
          const name = (categoryNameInput?.value || "").trim();
          if (!name) { categoryNameInput?.focus(); return; }

          const originalText = createCategoryBtn.textContent;
          createCategoryBtn.disabled = true;
          createCategoryBtn.textContent = "Creating...";

          try {
            const res = await fetch("/chat/api/categories/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": CSRF_TOKEN,
              },
              body: JSON.stringify({ name }),
            });

            const data = await res.json();
            if (!res.ok) { alert(data.error || "Failed to create category."); return; }

            closeCategoryModal();
            window.location.reload();
          } catch (e) {
            alert("Network error creating category.");
          } finally {
            createCategoryBtn.disabled = false;
            createCategoryBtn.textContent = originalText;
          }
        });
      }
    })();

    /* Init */
    fetchAllHighlights();
    loadChatHistoryCollapsed();
    loadTranslateMode();
  </script>
</body>
</html>