 {% block content %}
{% load static %}

<!DOCTYPE html>

<html>

<head>

<meta charset="UTF-8">

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="{% static 'accounts/css/nucleo-icons.css' %}" rel="stylesheet">
  <link href="{% static 'accounts/css/nucleo-svg.css' %}" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>

  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'accounts/css/soft-ui-dashboard.css' %}" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/svg+xml" href="{% static 'accounts/img/ele.png' %}">

<title>Chinese Log</title>

<style>
body {
  margin: 0;
  transition: padding-top 0.3s ease-in-out; /* For download notification bar */
}

.subplayer-page {
  background-color: #F9F8FA;
}

/* Ensure navbar stays above sidebars */
.subplayer-page .navbar {
  z-index: 1001;
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
}

/* ========== Subtitles / Highlights in player ========== */

.subtitles-container span,
#subtitles span {
  display: inline-block;
  padding: 2px 5px;
  color: #2f302f;
}

#subtitles span.highlight,
#subtitles span.active-highlight,
#subtitles span.perm-highlight {
  font-weight: bold;
  padding: 2px 4px;
  border-radius: 5px;
}

#subtitles span.highlight {
  color: #fff;
  background-color: yellow;
}

#subtitles span.active-highlight {
  background-color: #4285f4;
  color: #fff;
}

#subtitles span.perm-highlight {
  background-color: rgba(255, 255, 0, 0.5);
  color: #333;
}

/* Base subtitles container (will be refined later for modern look) */
.subtitles-container {
  margin: 0 auto;
  max-height: 24vh;
  text-align: center;
  font-size: calc(1vw + 1vh);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  overflow-y: auto;
  padding: 10px;
  background-color: #fff;
  width: 100%;
  max-width: calc(100% - 40px);
  box-sizing: border-box;
}

/* ========== Layout: dashboard / sidebars / media content (clean base) ========== */

.dashboard {
  display: flex;
  flex-direction: row;
  width: 100%;
  min-height: 100vh;
  position: relative;
}

/* Base sidebar */
.sidebar {
  height: 100vh;
  position: fixed;
  top: 0;
  overflow-y: auto;
  background-color: #FFFFFF;
  box-sizing: border-box;
  z-index: 1000;
  transition: all 0.3s ease-in-out;
}

/* Left sidebar */
.left-sidebar {
  left: 0;
  width: 240px;
  padding: 20px;
}

/* Right sidebar (modern look) */
.right-sidebar {
  right: 0;
  width: 240px;
  height: 100vh;
  position: fixed;
  top: 0;
  padding: 24px 16px;
  overflow-y: auto;
  background-color: #f8fafc;
  box-sizing: border-box;
  border-left: 1px solid #e2e8f0;
  margin: 20px 20px 20px 0;
  box-shadow: -4px 0 15px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

/* Media content in center (base) */
.media-content {
  flex-grow: 1;
  padding: 20px;
  box-sizing: border-box;
  margin-left: 260px;  /* 240 + 20 gap */
  margin-right: 260px; /* 240 + 20 gap */
  width: calc(100% - 520px);
  transition:
    margin-left 0.3s ease-in-out,
    margin-right 0.3s ease-in-out,
    width 0.3s ease-in-out;
}

/* ========== Video container (modern look) ========== */

.video-container {
  margin: 0 auto;
  height: 70vh;
  text-align: center;
  overflow: hidden;
  width: 100%;
  max-width: calc(100% - 40px);
  box-sizing: border-box;

  /* Modern styling */
  background-color: #020617;
  border-radius: 18px;
  box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.video-container iframe {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 18px;
}

/* ========== Side nav (left) link states ========== */

.nav-link {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding-left: 12px;
  padding-right: 8px;
  max-width: calc(100% - 8px);
  box-sizing: border-box;
  border-radius: 8px;
  transition:
    background-color 0.2s ease-in-out,
    color 0.2s ease-in-out;
}

.nav-link .icon {
  min-width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-link span {
  white-space: nowrap;
  flex-grow: 1;
}

.nav-link.active {
  background: linear-gradient(135deg, #1a1f36 0%, #3a9fff 100%);
  color: #ffffff !important;
}

.nav-link:hover {
  background-color: rgba(128, 128, 128, 0.1);
}

/* Slight right gap */
.navbar-nav {
  padding-right: 8px;
}
.nav-item {
  margin-right: 8px;
}

/* ========== Sidebar toggles (left + right) ========== */

.sidebar-header {
  position: relative;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}

/* Generic toggle buttons */
.sidebar-toggle,
.sidebar-expand {
  background-color: white;
  border: 1px solid #e2e8f0;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0;
}

/* Hover state */
.sidebar-toggle:hover,
.sidebar-expand:hover {
  background-color: #f8fafc;
  transform: scale(1.05);
}

.sidebar-toggle svg,
.sidebar-expand svg {
  width: 16px;
  height: 16px;
  stroke: #64748b;
}

/* Left sidebar toggle location (bottom-left) */
.left-sidebar .sidebar-toggle,
.left-sidebar .sidebar-expand {
  position: absolute;
  bottom: 20px;
  left: 10px;
}

/* Right sidebar toggle location (top-right inside header) */
.right-sidebar .sidebar-toggle {
  position: absolute;
  top: 20px;
  right: 20px;
}

/* Expand button for right sidebar fixed at top-right of viewport when collapsed */
.right-sidebar .sidebar-expand {
  position: fixed;
  top: 20px;
  right: 20px;
  display: none;
  z-index: 1001;
}

/* Visibility rules */
.sidebar-expand {
  display: none;
}

.collapsed .sidebar-toggle {
  display: none;
}

.collapsed .sidebar-expand {
  display: block;
}

/* ========== XP display + Study guide button (right sidebar header) ========== */

.xp-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

/* XP pill */
#unique-xp-display {
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
  transition: all 0.2s ease;
  font-weight: 600;
}

#unique-xp-display .unique-xp-circle {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(4px);
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.85rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Study guide button */
#create-study-sheet {
  background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
  transition: all 0.2s ease;
  margin-left: 10px;
}

#create-study-sheet:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(14, 165, 233, 0.3);
  background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
}

#create-study-sheet svg {
  width: 22px;
  height: 22px;
  fill: white;
}
#create-study-sheet svg path {
  fill: white;
}

/* Tooltip specifically for study guide */
.study-guide-tooltip {
  width: 80px;
  white-space: normal;
  word-wrap: break-word;
  text-align: center;
  padding: 5px;
  font-size: 12px;
  line-height: 1.4;
}

/* ========== Highlight list in right sidebar ========== */

.highlight-list-container {
  flex-grow: 1;
  overflow-y: auto;
}

#highlight-list {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.highlight-item {
  margin-bottom: 10px;
}

.highlight-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: white;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  margin: 8px 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.highlight-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  background-color: #f1f5f9;
}

.highlight-container a {
  text-decoration: none;
  color: #1e293b;
  font-size: 0.925rem;
  line-height: 1.5;
  font-weight: 500;
  flex-grow: 1;
  margin-right: 10px;
}

.delete-highlight {
  width: 16px;
  height: 16px;
  cursor: pointer;
  opacity: 0;
  filter: grayscale(1);
  transition: all 0.2s ease;
}

.highlight-container:hover .delete-highlight {
  opacity: 0.6;
}

.delete-highlight:hover {
  opacity: 1 !important;
  filter: grayscale(0);
  transform: scale(1.1);
}

.played-highlight {
  background-color: #f0f9ff;
  border-left: 3px solid #3b82f6;
}

/* ========== Play-all button in right sidebar ========== */

.bottom-buttons {
  margin-top: 20px;
  padding-bottom: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.button-xp-container {
  display: flex;
  width: 100%;
  justify-content: center;
  align-items: center;
}

#play-all-btn {
  background: linear-gradient(135deg, #007BFF 0%, #3a9fff 100%);
  color: white;
  padding: 12px 24px;
  border-radius: 16px;
  font-weight: 600;
  font-size: 0.95rem;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
  transition: all 0.2s ease;
  width: 100%;
  max-width: 200px;
  height: 44px;
  letter-spacing: 0.3px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#play-all-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
  background: linear-gradient(135deg, #0056b3 0%, #007BFF 100%);
}

/* ========== Central buttons container under subtitles ========== */

.buttons-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin: 20px auto;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 12px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  max-width: calc(178vh * 0.7);
}

.button-group {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Icon + dictionary buttons unified */
.icon-button,
.dictionary-button {
  width: 36px;
  height: 36px;
  padding: 8px;
  border-radius: 8px;
  background-color: white;
  border: 2px solid #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.icon-button:hover,
.dictionary-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border-color: #007BFF;
}

.icon-button:active,
.dictionary-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.icon-button img,
.dictionary-button svg {
  width: 20px;
  height: 20px;
  transition: all 0.3s ease;
}

.icon-button:hover img,
.dictionary-button:hover svg {
  filter: brightness(0) saturate(100%) invert(40%) sepia(100%) saturate(2000%)
          hue-rotate(200deg) brightness(90%) contrast(90%);
}

/* Dictionary button active state */
.dictionary-button.active {
  background-color: #eff6ff;
  border-color: #2563eb;
}
.dictionary-button.active svg {
  stroke: #2563eb;
}

/* ========== Loop button – modern look ========== */

/* Override generic icon button for loop specifically */
#loop-icon {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  border: none;
  background: radial-gradient(circle at 30% 0%, #e0f2fe, #e5e7ff);
  box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition:
    transform 0.2s ease,
    box-shadow 0.2s ease,
    background 0.2s ease;
  padding: 0;
}

/* Loop icon sizing */
#loop-icon svg {
  width: 22px;
  height: 22px;
  max-width: 24px;
  max-height: 24px;
  fill: #0f172a;
  transition:
    transform 0.2s ease,
    fill 0.2s ease;
}

/* Hover state */
#loop-icon:hover {
  transform: translateY(-1px);
  box-shadow: 0 7px 16px rgba(15, 23, 42, 0.22);
}

#loop-icon:hover svg {
  transform: scale(1.05);
}

/* Loop active state (JS toggles .active) */
.icon-button.active {
  background-color: #007BFF;
  border-color: #007BFF;
  box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
}

#loop-icon.active {
  background: linear-gradient(135deg, #0ea5e9, #2563eb);
  box-shadow: 0 10px 20px rgba(37, 99, 235, 0.38);
}

#loop-icon.active svg {
  fill: #FFFFFF;
}

/* Highlight icon sizing */
#highlight-icon svg {
  width: 20px;
  height: 20px;
  transition: all 0.3s ease;
}

/* Tooltip shared */
.tooltip-text {
  visibility: hidden;
  width: 140px;
  background-color: #333;
  color: white;
  text-align: center;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition:
    opacity 0.3s,
    visibility 0.3s;
  font-size: 12px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.button-group:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* ========== Limit popup / generic overlay ========== */

.limit-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  background-color: white;
  width: 90%;
  max-width: 400px;
  border-radius: 12px;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  box-shadow: none !important;
}

.limit-popup::before,
.limit-popup::after {
  display: none !important;
}

.limit-popup.active,
.overlay.active {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

.popup-content {
  padding: 24px;
}

.popup-header {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.warning-icon {
  background-color: #FEF3C7;
  color: #D97706;
  padding: 8px;
  border-radius: 50%;
  margin-right: 12px;
}

.popup-title {
  font-size: 18px;
  font-weight: 600;
  color: #1F2937;
  margin: 0;
}

.popup-message {
  color: #6B7280;
  margin-bottom: 24px;
  line-height: 1.5;
}

.button-container {
  display: flex;
  gap: 12px;
}

.upgrade-button {
  flex: 1;
  padding: 12px;
  background-color: #3B82F6;
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.upgrade-button:hover {
  background-color: #2563EB;
}

.close-button {
  flex: 1;
  padding: 12px;
  background-color: #F3F4F6;
  color: #4B5563;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.close-button:hover {
  background-color: #E5E7EB;
}

/* ========== Selection-required popup (for “select some text first”) ========== */

.selection-required-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background-color: white;
  width: 90%;
  max-width: 350px;
  border-radius: 12px;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
}

.selection-required-popup.active {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: auto;
}

.selection-required-popup .popup-content {
  padding: 20px;
}

.selection-required-popup .popup-header {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}

.selection-required-popup .info-icon {
  background-color: #dbeafe;
  color: #3b82f6;
  padding: 6px;
  border-radius: 50%;
  margin-right: 10px;
  font-size: 16px;
}

.selection-required-popup .popup-title {
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.selection-required-popup .popup-message {
  color: #6b7280;
  margin-bottom: 20px;
  line-height: 1.4;
  font-size: 14px;
}

.selection-required-popup .close-button {
  width: 100%;
  padding: 10px;
  background-color: #f3f4f6;
  color: #4b5563;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.selection-required-popup .close-button:hover {
  background-color: #e5e7eb;
}

/* Generic overlay (used for limit + study guide + selection) */
.overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* Study guide popup reuses .limit-popup styles */
#study-guide-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background-color: white;
  width: 90%;
  max-width: 400px;
  border-radius: 12px;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
}

#study-guide-popup.active {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: auto;
}

#study-guide-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* ========== Zhongwen popup styles (dictionary) ========== */

#zhongwen-window,
#zhongwen-window * {
  width: auto;
  height: auto;
  background: transparent;
  border: none !important;
  margin: 0;
  padding: 0;
  letter-spacing: normal;
  text-align: left;
  text-decoration: none;
  text-indent: 0;
  text-transform: none;
  white-space: normal;
  word-spacing: normal;
  font-weight: normal;
  font-size: 12px;
  font-family: Tahoma, Geneva, sans-serif;
  visibility: visible;
  line-height: initial;
}

#zhongwen-window {
  position: absolute;
  z-index: 999999999;
  border: 1px solid #d0d0d0 !important;
  padding: 4px;
  background: #e6f4ff;
  top: 5px;
  left: 5px;
  min-width: 100px;
  border-radius: 5px;
  box-shadow: 10px 10px 5px -5px #999999;
}

#zhongwen-window .w-hanzi {
  font-size: 32px;
  margin-right: 0.7em;
}
#zhongwen-window .w-pinyin {
  font-size: 18px;
}
#zhongwen-window .w-def {
  font-size: 16px;
}
#zhongwen-window .w-zhuyin {
  font-family: PMingLiU, 'Apple LiGothic', sans-serif;
  font-size: 16px;
}
#zhongwen-window .w-hanzi-small {
  font-size: 18px;
  margin-right: 0.7em;
}
#zhongwen-window .w-pinyin-small {
  font-size: 16px;
}
#zhongwen-window .w-def-small {
  font-size: 12px;
}
#zhongwen-window .w-zhuyin-small {
  font-family: PMingLiU, 'Apple LiGothic', sans-serif;
  font-size: 12px;
}
#zhongwen-window .grammar,
#zhongwen-window .vocab {
  font-weight: bold;
}

/* Background color variants */
#zhongwen-window.background-yellow,
#zhongwen-window.background-yellow * {
  color: #000000;
  background: #ffffbf;
}
#zhongwen-window.background-yellow .w-hanzi,
#zhongwen-window.background-yellow .w-hanzi-small {
  color: #7070e0;
}
#zhongwen-window.background-yellow .grammar,
#zhongwen-window.background-yellow .vocab {
  color: #00008b;
}

#zhongwen-window.background-lightblue,
#zhongwen-window.background-lightblue * {
  color: #000000;
  background: #e6f4ff;
}
#zhongwen-window.background-lightblue .w-hanzi,
#zhongwen-window.background-lightblue .w-hanzi-small {
  color: #3082bf;
}
#zhongwen-window.background-lightblue .w-pinyin,
#zhongwen-window.background-lightblue .w-pinyin-small {
  color: #00b366;
}
#zhongwen-window.background-lightblue .grammar,
#zhongwen-window.background-lightblue .vocab {
  color: #00008b;
}

#zhongwen-window.background-blue,
#zhongwen-window.background-blue * {
  color: #ffffff;
  background: #5c73b8;
}
#zhongwen-window.background-blue .w-hanzi,
#zhongwen-window.background-blue .w-hanzi-small {
  color: #b7e7ff;
}
#zhongwen-window.background-blue .w-pinyin,
#zhongwen-window.background-blue .w-pinyin-small {
  color: #c0ffc0;
}
#zhongwen-window.background-blue .grammar,
#zhongwen-window.background-blue .vocab {
  color: #add8e6;
}

#zhongwen-window.background-black,
#zhongwen-window.background-black * {
  color: #ffffff;
  background: #000000;
}
#zhongwen-window.background-black .w-hanzi,
#zhongwen-window.background-black .w-hanzi-small {
  color: #7070e0;
}
#zhongwen-window.background-black .w-pinyin,
#zhongwen-window.background-black .w-pinyin-small {
  color: #20a020;
}
#zhongwen-window.background-black .grammar,
#zhongwen-window.background-black .vocab {
  color: #add8e6;
}

/* Tone color schemes */
#zhongwen-window.tonecolor-standard .tone1 { color: #ee363e; }
#zhongwen-window.tonecolor-standard .tone2 { color: #f47c36; }
#zhongwen-window.tonecolor-standard .tone3 { color: #73bb4f; }
#zhongwen-window.tonecolor-standard .tone4 { color: #649cd3; }
#zhongwen-window.tonecolor-standard .tone5 { color: #a0a0a0; }

#zhongwen-window.tonecolor-pleco .tone1 { color: #e30000; }
#zhongwen-window.tonecolor-pleco .tone2 { color: #02b31c; }
#zhongwen-window.tonecolor-pleco .tone3 { color: #1510f0; }
#zhongwen-window.tonecolor-pleco .tone4 { color: #8900bf; }
#zhongwen-window.tonecolor-pleco .tone5 { color: #777777; }

#zhongwen-window.tonecolor-hanping .tone1 { color: #64b4ff; }
#zhongwen-window.tonecolor-hanping .tone2 { color: #30b030; }
#zhongwen-window.tonecolor-hanping .tone3 { color: #f08000; }
#zhongwen-window.tonecolor-hanping .tone4 { color: #d00020; }
#zhongwen-window.tonecolor-hanping .tone5 { color: #a0a0a0; }

/* ========== Top download notification bar ========== */

#download-notification {
  background-color: #f8f9fa;
  color: #344767;
  border: none;
  border-bottom: 2px solid #e9ecef;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  padding: 10px 15px;
  font-size: 14px;
  width: 100%;
  text-align: center;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1060;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

#download-notification.show {
  opacity: 1;
}

/* Scrollbar styling in right sidebar */
.right-sidebar::-webkit-scrollbar {
  width: 6px;
}
.right-sidebar::-webkit-scrollbar-track {
  background: #f1f5f9;
}
.right-sidebar::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}
.right-sidebar::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ========== Responsive breakpoints (base) ========== */

@media (max-width: 992px) {
  .left-sidebar {
    display: none !important;
  }
  .media-content {
    margin-left: 0 !important;
    width: calc(100% - 260px);
  }
}

@media (max-width: 768px) {
  .right-sidebar {
    display: none !important;
  }
  .media-content {
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
  }
  .buttons-container {
    padding: 10px;
    gap: 15px;
  }
  .icon-button,
  .dictionary-button {
    width: 32px;
    height: 32px;
    padding: 6px;
  }
}

/* =====================================================================
   RESTORE ORIGINAL SIDEBAR / FULLSCREEN BEHAVIOR (OVERRIDES ABOVE)
   ===================================================================== */

/* Dashboard layout */
.dashboard {
  display: flex;
  flex-direction: row;
  width: 100%;
  min-height: 100vh;
  position: relative;
}

/* Center media content with sidebars on both sides */
.media-content {
  flex-grow: 1;
  padding: 20px;
  margin-left: 260px;  /* 240px left + 20px gap */
  margin-right: 260px; /* 240px right + 20px gap */
  width: calc(100% - 520px);
  transition:
    margin-left 0.3s ease-in-out,
    margin-right 0.3s ease-in-out,
    width 0.3s ease-in-out;
  box-sizing: border-box;
}

/* LEFT SIDEBAR base + collapsed width */
.left-sidebar {
  width: 240px; /* Default width */
  transition: width 0.3s ease-in-out;
}

.left-sidebar.collapsed {
  width: 40px;
  overflow: hidden;
}

/* RIGHT SIDEBAR – base state (matching original) */
.right-sidebar {
  right: 0;
  width: 240px;
  height: 100vh;
  position: fixed;
  top: 0;
  padding: 24px 16px;
  overflow-y: auto;
  background-color: #f8fafc;
  box-sizing: border-box;
  z-index: 1000;
  transition: all 0.3s ease;
  border-left: 1px solid #e2e8f0;
  margin: 20px 20px 20px 0;
  box-shadow: -4px 0 15px rgba(0, 0, 0, 0.05);
}

/* RIGHT SIDEBAR – collapsed (hide off-screen to the right) */
.right-sidebar.collapsed {
  transform: translateX(100%);
  width: 0;
  overflow: hidden;
  padding: 0;
  margin: 0;
}

/* When ONLY left sidebar is collapsed */
.left-sidebar.collapsed:not(.right-sidebar.collapsed) ~ .media-content {
  margin-left: 40px;   /* collapsed left */
  margin-right: 250px; /* open right */
  width: calc(100% - 290px);
}

/* When ONLY right sidebar is collapsed */
.right-sidebar.collapsed ~ .media-content {
  margin-right: 20px; /* keep left gap, no right sidebar */
  width: calc(100% - 280px);
}

/* When BOTH sidebars are collapsed – maximize center area */
.left-sidebar.collapsed + .right-sidebar.collapsed ~ .media-content {
  margin-left: 60px; /* 40px collapsed + 20px gap */
  margin-right: 20px; /* just gap on right */
  width: calc(100% - 80px);
}

/* Video and subtitles sizing in normal mode (modern styling kept) */
.video-container {
  margin: 0 auto;
  height: 70vh;
  text-align: center;
  overflow: hidden;
  width: 100%;
  max-width: calc(100% - 40px);
  box-sizing: border-box;
  background-color: #020617;
  border-radius: 18px;
  box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
}

.subtitles-container {
  margin: 16px auto 0;
  max-height: 24vh;
  text-align: center;
  font-size: calc(1vw + 1vh);
  overflow-y: auto;
  padding: 12px 16px;
  width: 100%;
  max-width: calc(100% - 40px);
  box-sizing: border-box;
  background: #f9fafb;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
}

/* When BOTH sidebars collapsed – make video/subtitles larger */
.left-sidebar.collapsed + .right-sidebar.collapsed ~ .media-content .video-container {
  height: 85vh;
  width: 100%;
  max-width: calc(100% - 40px);
  margin: 0 auto;
}

.left-sidebar.collapsed + .right-sidebar.collapsed ~ .media-content .subtitles-container {
  max-height: 30vh;
  width: 100%;
  max-width: calc(100% - 40px);
  margin: 12px auto 0;
}

/* When BOTH sidebars collapsed – vertical buttons bar on the right */
.left-sidebar.collapsed + .right-sidebar.collapsed ~ .media-content .buttons-container {
  position: fixed;
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
  flex-direction: column;
  width: auto;
  max-width: 60px;
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 8px 0 0 8px;
  box-shadow: -2px 0 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  margin: 0;
}

.left-sidebar.collapsed + .right-sidebar.collapsed ~ .media-content .buttons-container .button-group {
  flex-direction: column;
  align-items: center;
  margin: 5px 0;
}

/* Responsive – original behavior override */
@media (max-width: 992px) {
  .left-sidebar {
    display: none !important;
  }
  .media-content {
    margin-left: 0 !important;
  }
}

@media (max-width: 768px) {
  .right-sidebar {
    display: none !important;
  }
  .media-content {
    margin-right: 0 !important;
    margin-left: 0 !important;
    width: 100% !important;
  }
}

/* Hide left sidebar completely when collapsed (full-screen mode) */
.left-sidebar.collapsed {
  transform: translateX(-100%);
  width: 0;
  padding: 0;
  margin: 0;
  overflow: hidden;
}


</style>
    <meta name="csrf-token" content="{{ csrf_token }}">

</head>


<body class="subplayer-page">
<div id="download-notification" class="alert alert-light fade fixed-top" role="alert" style="z-index: 1060; display: none;">
  <div class="container-fluid py-2">
    <div class="d-flex align-items-center justify-content-center">
      <span>Your study guide is downloading. This may take a couple of minutes...</span>
    </div>
  </div>
</div>
<div class="dashboard">
 <aside class="sidebar left-sidebar">
    {% include 'accounts/sidebar.html' %}
 <button class="sidebar-toggle" onclick="toggleLeftSidebar('collapse')">
    <div class="toggle-button-inner">
        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
    </div>
</button>
<button class="sidebar-expand" onclick="toggleLeftSidebar('expand')" style="display: none;">
    <div class="toggle-button-inner">
        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 6l6 6-6 6"/>
        </svg>
    </div>
</button>
</aside>

<aside class="sidebar right-sidebar">
    <div class="sidebar-header">
        <div class="xp-container d-flex align-items-center">
            <!-- XP Button -->
            <div class="btn btn-purple btn-sm mb-0 d-flex align-items-center compact-btn" id="unique-xp-display">
                <div class="unique-xp-circle d-flex align-items-center justify-content-center me-2">XP</div>
                <span id="unique-xp-points">{{ total_points }}</span>
            </div>

            <!-- Study Guide Button -->
            <div class="button-group">
                <button id="create-study-sheet" title="Create Study Guide">
                    <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                        <path d="M437.456,512H21.212c-8.166,0-14.786-6.621-14.786-14.786V256.915c0-8.165,6.62-14.786,14.786-14.786 s14.786,6.621,14.786,14.786v225.512h386.671v-32.939c0-8.165,6.62-14.786,14.786-14.786s14.786,6.621,14.786,14.786v47.725 C452.242,505.379,445.622,512,437.456,512z"></path>
                        <polygon points="21.212,177.092 21.212,172.3 176.068,14.786 176.068,177.092"></polygon>
                        <rect x="196.524" y="219.426" width="294.274" height="163.712"></rect>
                        <path d="M490.791,204.634h-38.549V14.786c0-8.165-6.62-14.786-14.786-14.786H176.068 c-0.067,0-0.132,0.009-0.198,0.01c-0.359,0.004-0.717,0.022-1.075,0.053c-0.12,0.01-0.241,0.021-0.361,0.034 c-0.41,0.046-0.816,0.105-1.22,0.185c-0.031,0.006-0.061,0.009-0.092,0.015c-0.432,0.089-0.858,0.2-1.28,0.325 c-0.111,0.033-0.22,0.071-0.33,0.106c-0.322,0.105-0.642,0.22-0.958,0.347c-0.108,0.044-0.217,0.086-0.324,0.132 c-0.807,0.346-1.585,0.766-2.326,1.257c-0.102,0.067-0.2,0.139-0.3,0.207c-0.274,0.191-0.541,0.392-0.803,0.603 c-0.099,0.08-0.198,0.157-0.294,0.24c-0.339,0.287-0.67,0.586-0.985,0.906L10.668,161.935c-0.346,0.352-0.671,0.719-0.977,1.1 c-0.182,0.226-0.342,0.463-0.509,0.696c-0.112,0.157-0.234,0.309-0.34,0.47c-0.194,0.294-0.364,0.599-0.534,0.903 c-0.062,0.112-0.133,0.219-0.192,0.333c-0.166,0.315-0.308,0.639-0.449,0.963c-0.05,0.114-0.108,0.225-0.155,0.34 c-0.126,0.312-0.231,0.628-0.336,0.946c-0.046,0.139-0.099,0.274-0.14,0.413c-0.087,0.294-0.152,0.591-0.22,0.889 c-0.04,0.172-0.087,0.34-0.121,0.515c-0.053,0.274-0.084,0.55-0.121,0.825c-0.027,0.201-0.062,0.399-0.081,0.6 c-0.025,0.268-0.03,0.535-0.04,0.801c-0.007,0.191-0.028,0.38-0.028,0.571v4.792c0,8.165,6.62,14.786,14.786,14.786h154.855 c8.166,0,14.786-6.621,14.786-14.786V29.572h231.816v175.062H196.518c-8.166,0-14.786,6.621-14.786,14.786v163.705 c0,8.165,6.62,14.786,14.786,14.786h294.272c8.166,0,14.786-6.621,14.786-14.786V219.421 C505.577,211.256,498.957,204.634,490.791,204.634z M51.772,162.308l47.938-48.76l61.571-62.63v111.39L51.772,162.308 L51.772,162.308z M476.005,368.339h-264.7V234.207h264.7V368.339z"></path>
                        <path d="M246.08,260.736c0-3.2,2.925-6.015,7.375-6.015h26.322c16.785,0,30.008,7.934,30.008,29.433v0.64 c0,21.499-13.733,29.689-31.28,29.689h-12.589v27.641c0,4.096-4.959,6.142-9.919,6.142s-9.919-2.048-9.919-6.142L246.08,260.736 L246.08,260.736z M265.916,272.124v27.002h12.589c7.121,0,11.444-4.096,11.444-12.797v-1.406c0-8.703-4.323-12.797-11.444-12.797 h-12.589V272.124z"></path>
                        <path d="M349.586,254.721c17.548,0,31.282,8.19,31.282,30.202v33.145c0,22.011-13.733,30.201-31.282,30.201 h-22.507c-5.214,0-8.647-2.815-8.647-6.014v-81.518c0-3.2,3.433-6.015,8.647-6.015h22.507V254.721z M338.269,272.124v58.739h11.317 c7.121,0,11.444-4.096,11.444-12.796v-33.145c0-8.703-4.323-12.797-11.444-12.797h-11.317V272.124z"></path>
                        <path d="M393.458,260.863c0-4.096,4.323-6.142,8.647-6.142h44.125c4.196,0,5.977,4.479,5.977,8.574 c0,4.735-2.162,8.83-5.977,8.83h-32.935v21.628h19.201c3.815,0,5.977,3.711,5.977,7.806c0,3.456-1.78,7.55-5.977,7.55h-19.201 v33.016c0,4.096-4.959,6.142-9.919,6.142c-4.959,0-9.919-2.048-9.919-6.142V260.863z"></path>
                    </svg>
                </button>
                <span class="tooltip-text study-guide-tooltip">Create Study Guide</span>
            </div>
        </div>
    </div>

    <!-- Highlight List -->
    <div class="highlight-list-container">
        <ul id="highlight-list">
            {% for highlight in highlights %}
            <li class="highlight-item">
                <div class="highlight-container">
                    <a href="#"
                        data-start-time="{{ highlight.start_time }}"
                        data-end-time="{{ highlight.end_time }}"
                        data-frame-index="{{ highlight.frame_index }}"
                        data-start-sentence-index="{{ highlight.start_sentence_index }}"
                        data-start-index="{{ highlight.start_index }}">
                        {{ highlight.highlighted_text }}
                    </a>
                    <img src="{% static 'subplayer/trash.png' %}" alt="Delete" class="delete-highlight" data-highlight-id="{{ highlight.id }}">
                </div>
            </li>
            {% empty %}
            <li id="no-highlights">No highlights found.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Play All Button -->
    <div class="bottom-buttons">
        <div class="button-xp-container">
            <button id="play-all-btn" class="play-all-button">Play All Highlights</button>
        </div>
    </div>
</aside>



<div class="media-content">
    <audio id="audiofile" controls="controls" type="audio/mp3"></audio>
    <div class="video-container">
        <div id="player"></div>
    </div>
    <div class="subtitles-container" id="subtitles"></div>
    <div class="buttons-container">
    <!-- Status Button -->
   <div class="button-group">
    <button class="icon-button" id="status-icon">
        <img src="{% static 'subplayer/status.png' %}" alt="Set Status">
    </button>
    <span class="tooltip-text" id="status-tooltip">Set Status</span>
</div>

    <!-- Loop Button -->
    <div class="button-group">
    <div id="loop-icon" class="icon-button" title="Loop">
        <svg viewBox="0 0 17 17" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000">
            <g id="SVGRepo_iconCarrier">
                <path d="M1 9c0 2.206 1.711 4 3.813 4v1c-2.654 0-4.813-2.243-4.813-5s2.159-5 4.813-5h4.229l-1.646-1.646 0.707-0.707 2.854 2.853-2.853 2.854-0.708-0.708 1.647-1.646h-4.23c-2.102 0-3.813 1.794-3.813 4zM12.187 4v1c2.102 0 3.813 1.794 3.813 4s-1.711 4-3.813 4h-4.23l1.646-1.646-0.707-0.707-2.853 2.853 2.854 2.854 0.707-0.707-1.647-1.647h4.229c2.655 0 4.814-2.243 4.814-5s-2.159-5-4.813-5z" fill="#000000"></path>
            </g>
        </svg>
    </div>
    <span class="tooltip-text">Loop Mode: Select Text, Turn on Loop Mode (CMD Key)</span>
</div>

    <!-- Highlight Button -->
    <div class="button-group">
        <button class="icon-button" id="highlight-icon">
   <svg viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>highlight-filled</title> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="drop" fill="#000000" transform="translate(64.000000, 44.956885)"> <path d="M405.333333,381.709781 L362.666667,424.376448 L85.3333333,424.376448 L128,381.709781 L405.333333,381.709781 Z M41.168,299.372 L103.67,361.874 L42.6666667,392.376448 L1.42108547e-14,403.043115 L10.6666667,360.376448 L41.168,299.372 Z M61.1,191.304 L212.137,342.341 L206.971557,347.655494 L201.097332,347.365048 L194.94444,347.269241 C184.457401,347.271762 172.809254,348.085275 160,349.709781 L151.970104,350.837434 L144.123951,352.129117 L136.61735,353.518237 L127.387,355.421 L48.9491375,276.983016 C50.507182,270.709588 52.0860762,262.939495 53.3333333,253.709781 C55.8645145,234.979019 56.7941068,216.011107 56.1221103,196.806047 L59.4284876,193.08414 L61.1,191.304 Z M282.327442,7.10542736e-15 L403.006999,120.679557 L384.970948,143.928809 L352.415716,185.42913 L333.317316,209.393653 L316.302987,230.396289 L304.909911,244.204529 L291.542704,260.023864 L282.884971,269.944627 L275.399527,278.199329 L269.086373,284.787971 L254.094195,299.615469 L227.035,327.069 L75.976,176.01 L78.5389897,173.389008 L116.39305,135.764502 L128.060065,124.568671 L141.033549,112.687653 L152.352994,102.689504 L164.50858,92.2528346 L177.500305,81.3776459 L191.328171,70.0639374 L205.992177,58.3117091 L229.55595,39.8611422 L246.310307,27.0126145 L263.900804,13.7255671 L282.327442,7.10542736e-15 Z" id="Combined-Shape"> </path> </g> </g> </g></svg>


</button>
        <span class="tooltip-text">Highlight Mode: Select Text Then Click Shift</span>
    </div>

    <!-- Dictionary Button -->
    <div class="button-group">
       <button id="toggleDictionary" class="dictionary-button" onclick="toggleDictionary()">
    <svg width="36" height="36" viewBox="6 6 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
            <rect x="6" y="6" width="36" height="36" rx="3" fill="#2F88FF" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></rect>
            <path d="M21 19.9389C20.6008 18.7746 19.403 16.737 17.0076 17.0281C14.6122 17.3193 12.8152 20.5211 13.0152 24.5962C13.2152 28.6714 15.4106 31 17.4068 31C19.8023 31 21 28.2056 21 28.2056" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M26 31L26 19" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M26 31L26 24.5C26 22.0147 28.0147 20 30.5 20V20C32.9853 20 35 22.0147 35 24.5L35 31" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
        </g>
    </svg>
    <span class="tooltip-text">Dictionary</span>
</button>
        <span class="tooltip-text">Dictionary</span>
    </div>

    <!-- Toggle Sidebar Button -->
    <div class="button-group">
        <button class="icon-button" onclick="toggleSidebar()">
            <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <rect width="48" height="48" fill="white" fill-opacity="0.01"></rect>
                    <path d="M16 40H6C4.89543 40 4 39.1046 4 38V10C4 8.89543 4.89543 8 6 8H42C43.1046 8 44 8.89543 44 10V16" stroke="#000000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
                    <rect x="24" y="24" width="20" height="16" rx="2" fill="#2F88FF" stroke="#000000" stroke-width="4" stroke-linejoin="round"></rect>
                </g>
            </svg>
        </button>
        <span class="tooltip-text">Full Screen</span>
    </div>
</div>

    <div id="viewed-media-container"></div>
    <div id="highlight-display"></div>
</div>
<div id="media-status" data-status="{{ media_status }}"></div>

<!-- Study Guide Popup -->
<div id="study-guide-popup" class="limit-popup">
    <div class="popup-content">
        <div class="popup-header">
            <div class="warning-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12" y2="17"></line>
                </svg>
            </div>
            <h3 class="popup-title">Want to download your study guide?</h3>
        </div>
        <p class="popup-message">Click the button below to download your study guide.</p>
        <div class="button-container">
            <button class="upgrade-button" onclick="downloadStudyGuide()">Download Now</button>
            <button class="close-button" onclick="hideStudyGuidePopup()">Close</button>
        </div>
    </div>
</div>
<div id="study-guide-overlay" class="overlay"></div>
<script>
    let dictionaryEnabled = false; // Track if the dictionary is enabled

    var media = JSON.parse('{{ media_json|escapejs }}');
    var mediaId = media.media_id;
    var test2 = media.url;
    console.log("location" + test2);
    const mediaType = media.media_type;
    const audioPlayer = document.getElementById('audiofile');
    var userId = "{{ request.user.id }}";
    var profileId = "{{ request.user.profile.id }}";

    if (mediaType === 'audio') {
        audioPlayer.src = "{% static 'subplayer/audio/' %}" + media.media_id + ".mp3";
    } else {
        console.log("23434");
        document.getElementById('audiofile').style.display = 'none';
    }

    // Setup Highlight Links
    function setupHighlightLinks() {
        const highlights = document.querySelectorAll('#highlight-list a');
        highlights.forEach(highlight => {
            highlight.addEventListener('click', function(e) {
                e.preventDefault();
                const startTime = parseFloat(this.getAttribute('data-start-time'));
                if (player && !isNaN(startTime)) {
                    player.seekTo(startTime, true);
                }
            });
        });
    }

    // Toggle Sidebar (Both)
    function toggleSidebar() {
        const leftSidebar = document.querySelector('.left-sidebar');
        const rightSidebar = document.querySelector('.right-sidebar');
        const mediaContent = document.querySelector('.media-content');

        leftSidebar.classList.toggle('collapsed');
        rightSidebar.classList.toggle('collapsed');

        mediaContent.style.marginLeft = leftSidebar.classList.contains('collapsed') ? '40px' : '240px';
        mediaContent.style.marginRight = rightSidebar.classList.contains('collapsed') ? '0' : '250px';

        const leftCollapseButton = document.querySelector('.left-sidebar .sidebar-toggle');
        const leftExpandButton = document.querySelector('.left-sidebar .sidebar-expand');
        leftCollapseButton.style.display = leftSidebar.classList.contains('collapsed') ? 'none' : 'flex';
        leftExpandButton.style.display = leftSidebar.classList.contains('collapsed') ? 'flex' : 'none';

        localStorage.setItem('bothSidebars', leftSidebar.classList.contains('collapsed') ? 'collapsed' : 'expanded');
    }

    // Toggle Left Sidebar (Individual Control)
    function toggleLeftSidebar(action) {
        const leftSidebar = document.querySelector('.left-sidebar');
        const collapseButton = document.querySelector('.left-sidebar .sidebar-toggle');
        const expandButton = document.querySelector('.left-sidebar .sidebar-expand');
        const mediaContent = document.querySelector('.media-content');
        const rightSidebar = document.querySelector('.right-sidebar');

        if (action === 'collapse') {
            leftSidebar.classList.add('collapsed');
            collapseButton.style.display = 'none';
            expandButton.style.display = 'block';
            mediaContent.style.marginLeft = '60px';
            mediaContent.style.width = rightSidebar.classList.contains('collapsed') ? 'calc(100% - 80px)' : 'calc(100% - 320px)';
        } else if (action === 'expand') {
            leftSidebar.classList.remove('collapsed');
            collapseButton.style.display = 'block';
            expandButton.style.display = 'none';
            mediaContent.style.marginLeft = '260px';
            mediaContent.style.width = rightSidebar.classList.contains('collapsed') ? 'calc(100% - 280px)' : 'calc(100% - 520px)';
        }

        mediaContent.style.marginRight = rightSidebar.classList.contains('collapsed') ? '20px' : '260px';
        localStorage.setItem('leftSidebar', leftSidebar.classList.contains('collapsed') ? 'collapsed' : 'expanded');

        const playerIframe = document.querySelector('#player iframe');
        if (playerIframe) {
            playerIframe.style.width = '100%';
            playerIframe.style.height = '100%';
        }
    }

    // Play All Highlights
    document.getElementById('play-all-btn').addEventListener('click', playAllHighlights);

    async function playAllHighlights() {
        const highlights = document.querySelectorAll('#highlight-list a');
        let currentHighlightIndex = 0;
        await playHighlights(currentHighlightIndex, highlights);
    }

    async function playHighlights(currentHighlightIndex, highlights) {
        if (currentHighlightIndex < highlights.length) {
            const highlight = highlights[currentHighlightIndex];
            const startTime = parseFloat(highlight.getAttribute('data-start-time'));
            const endTime = parseFloat(highlight.getAttribute('data-end-time'));

            if (!isNaN(startTime) && !isNaN(endTime)) {
                await seekAndPlay(startTime);
                updateActiveHighlight(highlight);

                const highlightDuration = (endTime - startTime) * 1000;
                await new Promise(resolve => setTimeout(resolve, highlightDuration));

                currentHighlightIndex++;
                playHighlights(currentHighlightIndex, highlights);
            }
        } else {
            console.log('All highlights have been played.');
            player.pauseVideo();
        }
    }

    async function seekAndPlay(startTime) {
        player.seekTo(startTime, true);
        await new Promise(resolve => setTimeout(resolve, 500));
        player.playVideo();
    }

    function updateActiveHighlight(activeElement) {
        document.querySelectorAll('#highlight-list a').forEach(highlight => {
            highlight.classList.remove('played-highlight', 'active-highlight');
        });
        activeElement.classList.add('played-highlight', 'active-highlight');
    }

    // Delete Highlight
    async function deleteHighlight(highlightId) {
        try {
            const response = await fetch(`/api/user/delete_highlight/${highlightId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Assuming csrftoken2 was a typo
                },
                body: JSON.stringify({ highlight_id: highlightId }),
            });

            if (response.ok) {
                console.log("Highlight deleted successfully!");
                await fetchHighlights(mediaId);
                createSubtitles();
            } else {
                console.error('Failed to delete highlight:', await response.text());
            }
        } catch (error) {
            console.error('Error during delete highlight:', error);
        }
    }

    // Highlight Mode Toggle
   function toggleHighlightMode() {
    const highlightSvgGroup = document.querySelector('#highlight-icon g#drop'); // Target the group with fill

    document.addEventListener('keydown', function(event) {
        if (event.key === "Shift") {
            highlightSvgGroup.setAttribute('fill', '#FFD700'); // Yellow color
        }
    });

    document.addEventListener('keyup', function(event) {
        if (event.key === "Shift") {
            highlightSvgGroup.setAttribute('fill', '#000000'); // Black color
        }
    });
}
    // Status Functions
    function initializeStatusUI() {
        console.log('Initializing status UI');
        const mediaStatusElement = document.getElementById('media-status');
        const initialStatus = mediaStatusElement.getAttribute('data-status') || 'set-status';
        console.log('Initial status:', initialStatus);
        updateSingleStatusIcon(initialStatus);
    }

    function attachSingleStatusIconEventListener() {
        const statusIcon = document.getElementById('status-icon');
        statusIcon.addEventListener('click', function() {
            let newStatus;
            switch (this.dataset.status) {
                case 'in_progress':
                    newStatus = 'completed';
                    break;
                case 'completed':
                    newStatus = 'set-status';
                    break;
                case 'set-status':
                default:
                    newStatus = 'in_progress';
                    break;
            }
            toggleStatus(newStatus);
        });
    }

    async function toggleStatus(newStatus) {
        console.log("Toggle status called:", newStatus);
        const mediaId = '{{ media.media_id }}';
        const currentTime = player ? player.getCurrentTime() : 0;

        try {
            const url = `/media/update_status/${mediaId}/${newStatus}/`;
            const data = { status: newStatus, current_time: currentTime };
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log("Status update response:", result);

            if (result && result.status === 'success') {
                updateSingleStatusIcon(newStatus);
            } else {
                console.error('Failed to update status. Response:', result);
            }
        } catch (error) {
            console.error('Error updating media status:', error);
        }
    }

    function updateSingleStatusIcon(status) {
        console.log("Updating status icon to:", status);
        const statusIcon = document.getElementById('status-icon');
        const statusImg = statusIcon.querySelector('img');
        const statusTooltip = document.getElementById('status-tooltip');

        statusIcon.classList.remove('in-progress', 'completed', 'default');

        switch (status) {
            case 'in_progress':
                statusImg.src = '{% static "subplayer/in-prog.png" %}';
                statusIcon.classList.add('in-progress');
                statusTooltip.textContent = 'In Progress';
                break;
            case 'completed':
                statusImg.src = '{% static "subplayer/complete-check.png" %}';
                statusIcon.classList.add('completed');
                statusTooltip.textContent = 'Completed';
                break;
            case 'set-status':
            default:
                statusImg.src = '{% static "subplayer/status.png" %}';
                statusIcon.classList.add('default');
                statusTooltip.textContent = 'Set Status';
                break;
        }
        statusIcon.dataset.status = status;
    }

    // Dictionary Functions
    function toggleDictionary() {
        const dictionaryButton = document.getElementById('toggleDictionary');
        dictionaryButton.classList.toggle('active');
        dictionaryEnabled = dictionaryButton.classList.contains('active');

        if (!dictionaryEnabled) {
            hidePopup();
        }
    }

    function showPopup(word, definition, x, y) {
        let popup = document.getElementById('dictionary-popup');
        if (!popup) {
            popup = document.createElement('div');
            popup.id = 'dictionary-popup';
            document.body.appendChild(popup);
        }

        popup.innerHTML = `<strong>${word}</strong>: ${definition}`;
        popup.style.position = 'absolute';
        popup.style.left = `${x}px`;
        popup.style.top = `${y + 20}px`;
        popup.style.background = '#fff';
        popup.style.border = '1px solid #ccc';
        popup.style.padding = '10px';
        popup.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        popup.style.zIndex = '1000';
        popup.style.maxWidth = '300px';
        popup.style.borderRadius = '5px';
        popup.style.display = 'block';
    }

    function hidePopup() {
        const popup = document.getElementById('dictionary-popup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    async function fetchDefinition(word) {
        // Mock API call - replace with your actual dictionary API
        return new Promise(resolve => {
            setTimeout(() => {
                resolve(`Definition of ${word} (mocked)`);
            }, 500);
        });
        // Example: await fetch(`/api/dictionary/${word}/`).then(res => res.json());
    }

    // Utility Function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // DOMContentLoaded Event Listener
    document.addEventListener('DOMContentLoaded', function() {
        const leftSidebar = document.querySelector('.left-sidebar');
        const rightSidebar = document.querySelector('.right-sidebar');
        const mediaContent = document.querySelector('.media-content');
        const highlightList = document.getElementById('highlight-list');

        // Restore Sidebar States
        const bothSidebarsState = localStorage.getItem('bothSidebars');
        const leftSidebarState = localStorage.getItem('leftSidebar');
        const rightSidebarState = localStorage.getItem('rightSidebar');

        if (bothSidebarsState === 'collapsed') {
            toggleSidebar();
        }

        if (leftSidebarState === 'collapsed') {
            leftSidebar.classList.add('collapsed');
            mediaContent.style.marginLeft = '60px';
            document.querySelector('.left-sidebar .sidebar-toggle').style.display = 'none';
            document.querySelector('.left-sidebar .sidebar-expand').style.display = 'block';
        } else {
            mediaContent.style.marginLeft = '260px';
        }

        if (rightSidebarState === 'collapsed') {
            rightSidebar.classList.add('collapsed');
            mediaContent.style.marginRight = '20px';
        } else {
            mediaContent.style.marginRight = '260px';
        }

        mediaContent.style.width = (leftSidebarState === 'collapsed' && rightSidebarState === 'collapsed') ? 'calc(100% - 80px)' :
                                   (leftSidebarState === 'collapsed') ? 'calc(100% - 320px)' :
                                   (rightSidebarState === 'collapsed') ? 'calc(100% - 280px)' : 'calc(100% - 520px)';

        const playerIframe = document.querySelector('#player iframe');
        if (playerIframe) {
            playerIframe.style.width = '100%';
            playerIframe.style.height = '100%';
        }

        // Highlight Deletion
        highlightList.addEventListener('click', function(event) {
            let deleteBtn = event.target.closest('.delete-highlight');
            if (deleteBtn) {
                event.preventDefault();
                const highlightId = deleteBtn.getAttribute('data-highlight-id');
                deleteHighlight(highlightId).then(() => {
                    deleteBtn.closest('li').remove();
                    // Assuming checkHighlightExistence() exists elsewhere
                });
            }
        });

        // Dictionary Hover
        const contentArea = document.querySelector('.media-content'); // Adjust to your text container
        contentArea.addEventListener('click', async function(e) {
            if (!dictionaryEnabled) return;

            const selection = window.getSelection().toString().trim();
            if (selection) {
                const range = window.getSelection().getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const definition = await fetchDefinition(selection);
                showPopup(selection, definition, rect.left + window.scrollX, rect.top + window.scrollY);
            }
        });

        document.addEventListener('click', function(e) {
            const popup = document.getElementById('dictionary-popup');
            if (popup && !popup.contains(e.target) && e.target.id !== 'toggleDictionary') {
                hidePopup();
            }
        });

        // Initialize Features
        setupHighlightLinks();
        toggleHighlightMode();
        initializeStatusUI();
        attachSingleStatusIconEventListener();
    });
// Function to show the study guide popup
function showStudyGuidePopup() {
    const popup = document.getElementById('study-guide-popup');
    const overlay = document.getElementById('study-guide-overlay');
    popup.classList.add('active');
    overlay.classList.add('active');
}

// Function to hide the study guide popup
function hideStudyGuidePopup() {
    const popup = document.getElementById('study-guide-popup');
    const overlay = document.getElementById('study-guide-overlay');
    popup.classList.remove('active');
    overlay.classList.remove('active');
}

// Function to handle the download action
function downloadStudyGuide() {
    // Implement your download logic here
    console.log('Downloading study guide...');
    hideStudyGuidePopup();
}

// Attach event listener to the study guide button
document.getElementById('create-study-sheet').addEventListener('click', function(event) {
    event.preventDefault();
    showStudyGuidePopup();
});
</script>

{% if media.media_type == 'audio' %}
    {% include 'subtitles.html' with media=media %}
{% else %}
    <script src="{% static 'subplayer/js/subtitles_video.js' %}"></script>
    <script src="{% static 'subplayer/js/dc.js' %}"></script>
{% endif %}
<script>var DICT_BASE_PATH = "{% static 'subplayer/pop_dic/' %}";</script>
</body>

</html>

{% endblock %}