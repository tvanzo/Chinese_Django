{% load static %}

<style>
  :root {
    --primary-color: #3a9fff;
    --secondary-color: #7a1ea0;
    --accent-color: #d00c9c;
  }

  /* Navbar layout */
  .navbar-main {
    padding: 0.75rem 1rem !important;
    margin: 0 !important;
    background: transparent;
  }
  .navbar-main .container-fluid {
    max-width: none !important;
    padding: 0 0.5rem !important;
  }

  /* Avoid navbar squeezing */
  .navbar-main .nav-link {
    color: #64748b;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }
  .navbar-main .nav-link:hover { color: var(--primary-color); }

  /* XP pill */
  #unique-xp-display {
    background: linear-gradient(135deg, #1a1f36 0%, #3a9fff 100%);
    color: #fff !important;
    padding: 8px 14px;
    border-radius: 12px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(58, 159, 255, 0.18);
    border: none;
    white-space: nowrap;
  }
  #unique-xp-display .unique-xp-circle {
    background: rgba(255, 255, 255, 0.22);
    width: 24px;
    height: 24px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 0.85rem;
  }
  #unique-xp-points { font-weight: 800; }

  /* Mobile hamburger (ONE button) */
  .mobile-sidenav-btn {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s ease, box-shadow 0.15s ease;
    flex-shrink: 0;
  }
  .mobile-sidenav-btn:hover {
    background: #f3f4f6;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
  }
  @media (max-width: 768px) {
    .mobile-sidenav-btn { display: inline-flex; }
  }

  /* Drawer backdrop + right tap zone */
  .site-drawer-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(17, 24, 39, 0.50);
    display: none;
    z-index: 5000;
  }
  .site-drawer-backdrop.open { display: block; }

  .site-drawer-right-tap {
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    width: 15vw;
    display: none;
    z-index: 5002;
  }
  .site-drawer-right-tap.open { display: block; }

  /* Prevent scroll when drawer open */
  @media (max-width: 768px) {
    body.site-sidenav-open { overflow: hidden; }
  }
</style>

<nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl"
     id="navbarBlur" navbar-scroll="true">
  <div class="container-fluid py-1 px-3 d-flex align-items-center justify-content-between">

    <!-- Left: mobile menu -->
    <button class="mobile-sidenav-btn" id="siteSidenavOpenBtn" type="button" aria-label="Open menu">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Center: brand -->
    <div class="d-flex align-items-center" style="gap:10px; min-width:0;">
      <span class="d-none d-md-inline" style="font-weight:800; color:#111827;">
        Chinese Log
      </span>
    </div>

    <!-- Right: actions -->
    <div class="d-flex align-items-center" style="gap:10px;">
      <div class="btn btn-sm mb-0 d-flex align-items-center" id="unique-xp-display">
        <div class="unique-xp-circle">XP</div>
        <span id="unique-xp-points">{{ total_points }}</span>
      </div>

      <a href="/account" class="nav-link" style="display:inline-flex; align-items:center;">
        <div class="ms-2"
             style="position: relative; top: -2px;"
             data-bs-toggle="tooltip"
             data-bs-placement="bottom"
             title="{% if user.subscriptions.first.tier == 'PREMIUM' %}Premium Subscription{% else %}Free Subscription{% endif %}">
          <svg width="20px" height="20px" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"
               stroke="{% if user.subscriptions.first.tier == 'PREMIUM' %}#ffc40c{% else %}#808080{% endif %}"
               stroke-width="1.064">
            <path d="M21.2501 3C21.4925 3 21.7176 3.11688 21.8574 3.30983L21.9119 3.39706L25.9186 10.9098L25.9615 11.0122L25.9731 11.05L25.9901 11.1273L25.9994 11.2153L25.9973 11.3147L26.0001 11.25C26.0001 11.3551 25.9785 11.4552 25.9394 11.5461L25.9106 11.6057L25.87 11.6723L25.8173 11.7408L14.6 24.7047C14.4999 24.8391 14.3628 24.9277 14.2139 24.9703L14.1559 24.9844L14.0585 24.9979L13.9999 25L13.8993 24.9932L13.8142 24.9771L13.7109 24.9432L13.6852 24.931C13.5949 24.8911 13.5119 24.8316 13.4425 24.7535L2.17081 11.7263L2.1087 11.6387L2.06079 11.5456L2.02611 11.4463L2.00297 11.3152L2.00269 11.1878L2.01755 11.0891L2.02714 11.0499L2.06104 10.9538L2.08838 10.8971L6.08838 3.39706C6.20243 3.18321 6.41149 3.0396 6.64753 3.00704L6.75014 3H21.2501Z"
                  fill="{% if user.subscriptions.first.tier == 'PREMIUM' %}#ffc40c{% else %}#808080{% endif %}"></path>
          </svg>
        </div>
      </a>

      <a href="{% url 'logout' %}" class="ms-2" style="position: relative; top: -2px;" aria-label="Logout">
        <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 12L2 12M2 12L5.5 9M2 12L5.5 15"
                stroke="#1C274C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          <path d="M9.00195 7C9.01406 4.82497 9.11051 3.64706 9.87889 2.87868C10.7576 2 12.1718 2 15.0002 2L16.0002 2C18.8286 2 20.2429 2 21.1215 2.87868C22.0002 3.75736 22.0002 5.17157 22.0002 8L22.0002 16C22.0002 18.8284 22.0002 20.2426 21.1215 21.1213C20.3531 21.8897 19.1752 21.9862 17 21.9983M9.00195 17C9.01406 19.175 9.11051 20.3529 9.87889 21.1213C10.5202 21.7626 11.4467 21.9359 13 21.9827"
                stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path>
        </svg>
      </a>
    </div>
  </div>
</nav>

<div id="siteDrawerBackdrop" class="site-drawer-backdrop" aria-hidden="true"></div>
<div id="siteDrawerRightTap" class="site-drawer-right-tap" aria-hidden="true"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (window.bootstrap) {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
    }
  });

  (function () {
    const openBtn = document.getElementById("siteSidenavOpenBtn");
    const backdrop = document.getElementById("siteDrawerBackdrop");
    const rightTap = document.getElementById("siteDrawerRightTap");

    function isMobile() {
      return window.matchMedia("(max-width: 768px)").matches;
    }

    function openSidenav() {
      if (!isMobile()) return;
      document.body.classList.add("site-sidenav-open");
      backdrop.classList.add("open");
      rightTap.classList.add("open");
      backdrop.setAttribute("aria-hidden", "false");
      rightTap.setAttribute("aria-hidden", "false");
    }

    function closeSidenav() {
      document.body.classList.remove("site-sidenav-open");
      backdrop.classList.remove("open");
      rightTap.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
      rightTap.setAttribute("aria-hidden", "true");
    }

    if (openBtn) openBtn.addEventListener("click", openSidenav);
    if (backdrop) backdrop.addEventListener("click", closeSidenav);
    if (rightTap) rightTap.addEventListener("click", closeSidenav);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSidenav();
    });

    // close drawer after clicking a sidebar link
    document.addEventListener("click", (e) => {
      if (!isMobile()) return;
      if (!document.body.classList.contains("site-sidenav-open")) return;

      const sidenav = document.getElementById("sidenav-main");
      if (!sidenav) return;

      const a = e.target.closest("a");
      if (a && sidenav.contains(a)) closeSidenav();
    });

    // swipe-to-close (right swipe)
    let startX = null, startY = null, started = false;

    function onTouchStart(ev) {
      if (!isMobile()) return;
      if (!document.body.classList.contains("site-sidenav-open")) return;
      const t = ev.touches && ev.touches[0];
      if (!t) return;
      startX = t.clientX;
      startY = t.clientY;
      started = true;
    }

    function onTouchMove(ev) {
      if (!started) return;
      const t = ev.touches && ev.touches[0];
      if (!t) return;

      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      if (Math.abs(dx) > Math.abs(dy) && dx > 60) {
        started = false;
        closeSidenav();
      }
    }

    function onTouchEnd() {
      started = false;
      startX = null;
      startY = null;
    }

    if (backdrop) {
      backdrop.addEventListener("touchstart", onTouchStart, { passive: true });
      backdrop.addEventListener("touchmove", onTouchMove, { passive: true });
      backdrop.addEventListener("touchend", onTouchEnd, { passive: true });
    }
    if (rightTap) {
      rightTap.addEventListener("touchstart", onTouchStart, { passive: true });
      rightTap.addEventListener("touchmove", onTouchMove, { passive: true });
      rightTap.addEventListener("touchend", onTouchEnd, { passive: true });
    }

    window.addEventListener("resize", () => {
      if (!isMobile()) closeSidenav();
    });
  })();
</script>
