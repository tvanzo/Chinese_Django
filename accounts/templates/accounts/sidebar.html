{% load static %}
<aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3"
       id="sidenav-main"
       aria-label="Site navigation">

    <!-- Sidebar collapse handle (desktop) -->
    <button type="button"
            id="sidebar-toggle-btn"
            class="sidebar-toggle-btn"
            onclick="toggleSidebarCollapse()"
            aria-label="Toggle sidebar"
            title="Toggle sidebar">
        <i class="fas fa-chevron-left"></i>
    </button>

    <div class="sidenav-inner">
        <!-- Logo Header -->
        <div class="sidenav-header">
            <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
               aria-hidden="true" id="iconSidenav"></i>

            <a class="m-0 d-flex justify-content-center align-items-center"
               href="/"
               style="padding-left: 0px; text-decoration: none;">
                <span class="logo-text">Chinese<span class="logo-accent">Log</span></span>
                <span class="logo-dot"></span>
            </a>
        </div>

        <hr class="horizontal dark mt-0">

        <!-- Navigation Menu -->
        <div class="flex-grow-1">
            <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
                <ul class="navbar-nav">

                    <!-- 1. Dashboard -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'dashboard' in request.path or request.path == '/' %}active{% endif %}" href="/">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="-1 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3 13C4.65685 13 6 14.3431 6 16V21C6 22.6569 4.65685 24 3 24C1.34315 24 0 22.6569 0 21V16C0 14.3431 1.34315 13 3 13zM11 0C12.6569 0 14 1.34315 14 3V21C14 22.6569 12.6569 24 11 24C9.3431 24 8 22.6569 8 21V3C8 1.34315 9.3431 0 11 0zM19 7C20.6569 7 22 8.34315 22 10V21C22 22.6569 20.6569 24 19 24C17.3431 24 16 22.6569 16 21V10C16 8.34315 17.3431 7 19 7z" fill="#000000"></path>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">Dashboard</span>
                        </a>
                    </li>

                    <!-- 2. Chat -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'chat' in request.path %}active{% endif %}" href="/chat">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                                    <path d="M4 5C4 3.89543 4.89543 3 6 3H18C19.1046 3 20 3.89543 20 5V13C20 14.1046 19.1046 15 18 15H10L7 18.5C6.55474 19.0328 5.7 18.7153 5.7 18.01V15H6C4.89543 15 4 14.1046 4 13V5Z" fill="#000000"/>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">Chat</span>
                        </a>
                    </li>

                    <!-- 3. Watch -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'watch' in request.path or 'video' in request.path or 'channel' in request.path %}active{% endif %}" href="/watch">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <g>
                                        <path d="M256,0C114.625,0,0,114.625,0,256c0,141.374,114.625,256,256,256c141.374,0,256-114.626,256-256 C512,114.625,397.374,0,256,0z M351.062,258.898l-144,85.945c-1.031,0.626-2.344,0.657-3.406,0.031 c-1.031-0.594-1.687-1.702-1.687-2.937v-85.946v-85.946c0-1.218,0.656-2.343,1.687-2.938c1.062-0.609,2.375-0.578,3.406,0.031 l144,85.962c1.031,0.586,1.641,1.718,1.641,2.89C352.703,257.187,352.094,258.297,351.062,258.898z"></path>
                                    </g>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">Watch</span>
                        </a>
                    </li>

                    <!-- 4. Read -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'read' in request.path %}active{% endif %}" href="/read">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                                    <path d="M5 3C4.44772 3 4 3.44772 4 4V18C4 18.5523 4.44772 19 5 19H11C12.1046 19 13 19.8954 13 21V5C13 3.89543 12.1046 3 11 3H5Z" fill="#000000"/>
                                    <path d="M19 3H13V21C13 19.8954 13.8954 19 15 19H19C19.5523 19 20 18.5523 20 18V4C20 3.44772 19.5523 3 19 3Z" fill="#000000"/>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">Read</span>
                        </a>
                    </li>

                    <!-- 5. Library -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'library' in request.path %}active{% endif %}" href="/library">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M22 11.9342C22 11.956 22 11.978 22 12L22 16.0658C22 16.9523 22.0001 17.7161 21.9179 18.3278C21.8297 18.9833 21.631 19.6117 21.1213 20.1213C20.6117 20.631 19.9833 20.8297 19.3278 20.9179C18.7161 21.0001 17.9523 21.0001 17.0658 21L6.93416 21C6.04768 21.0001 5.28386 21.0001 4.6722 20.9179C4.01669 20.8297 3.38834 20.631 2.87867 20.1213C2.36901 19.6117 2.17027 18.9833 2.08213 18.3278C1.9999 17.7161 1.99994 16.9523 1.99999 16.0658L1.99999 11.9342C1.99994 11.0477 1.9999 10.2839 2.08213 9.67221C2.17027 9.0167 2.36901 8.38835 2.87867 7.87868C3.38834 7.36902 4.01669 7.17028 4.6722 7.08215C5.28386 6.99991 6.04768 6.99995 6.93417 7L17 7C17.022 7 17.044 7 17.0658 7C17.9523 6.99995 18.7161 6.99991 19.3278 7.08215C19.9833 7.17028 20.6117 7.36902 21.1213 7.87868C21.631 8.38835 21.8297 9.0167 21.9179 9.67221C22.0001 10.2839 22 11.0477 22 11.9342Z" fill="#323232"></path>
                                    <path d="M19 6.04361V5.71429C19 4.21523 17.7848 3 16.2857 3H7.71429C6.21523 3 5 4.21523 5 5.71429V6.0436C5.57491 5.99987 6.22076 5.99994 6.88123 6.00001L17.1187 6.00001C17.7792 5.99994 18.4251 5.99987 19 6.04361Z" fill="#323232"></path>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">My Library</span>
                        </a>
                    </li>

                    <!-- 6. Highlights -->
                    <li class="nav-item">
                        <a class="nav-link {% if 'highlights' in request.path %}active{% endif %}" href="/highlights">
                            <div class="icon icon-shape icon-sm shadow border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
                                <svg width="18px" height="18px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <g transform="translate(64.000000, 44.956885)">
                                        <path d="M405.333333,381.709781 L362.666667,424.376448 L85.3333333,424.376448 L128,381.709781 L405.333333,381.709781 Z"></path>
                                    </g>
                                </svg>
                            </div>
                            <span class="nav-link-text ms-1 d-lg-block d-none">Highlights</span>
                        </a>
                    </li>

                </ul>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="sidenav-footer">
            <div class="profile-container">
                <div class="profile-avatar">
                    {% if request.user.is_authenticated %}
                        {{ request.user.username|first|upper }}
                    {% else %}
                        G
                    {% endif %}
                </div>
                <div class="profile-info">
                    <span class="profile-name">
                        {% if request.user.is_authenticated %}
                            {{ request.user.username }}
                        {% else %}
                            Guest
                        {% endif %}
                    </span>
                    <span class="profile-level">Level 1</span>
                </div>
            </div>
        </div>

    </div>
</aside>

<!-- Mobile backdrop -->
<div id="site-sidenav-backdrop" class="site-sidenav-backdrop" aria-hidden="true"></div>

<style>
  /* -----------------------------------------
     Desktop base layout (YOUR ORIGINAL)
     ----------------------------------------- */
  .sidenav { display:flex; flex-direction:column; height:100vh; max-height:100vh; }
  .sidenav-inner { display:flex; flex-direction:column; height:100%; }

  #sidenav-main {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 240px;
    transition: width 0.25s ease, transform 0.22s ease;
    z-index: 1040;
  }

  .main-content {
    margin-left: 260px;
    transition: margin-left 0.25s ease;
  }

  .logo-text {
    font-size: 22px;
    font-weight: 700;
    background: linear-gradient(135deg, #1a1f36 0%, #3a9fff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .logo-accent {
    background: linear-gradient(135deg, #3a9fff 0%, #3a72ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .logo-dot {
    position: relative;
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3a9fff 0%, #3a72ff 100%);
    animation: pulse 2s infinite;
    vertical-align: middle;
    margin-left: 5px;
    top: -2px;
  }

  .sidenav-header { flex-shrink:0; padding:1rem; height:100px; }
  .flex-grow-1 { flex-grow:1; overflow-y:auto; }
  .sidenav-footer { margin-top:auto; padding: 1rem 1rem 1.5rem 1rem; }

  .profile-container {
    display:flex; align-items:center;
    padding:0.65rem 0.75rem;
    background-color:#f5f7fb;
    border-radius:0.75rem;
    margin:0 0.25rem;
    gap:0.65rem;
  }
  .profile-avatar {
    width:34px;height:34px;border-radius:50%;
    background: radial-gradient(circle at 30% 0%, #4f46e5, #1d4ed8);
    display:flex;align-items:center;justify-content:center;
    font-weight:700;font-size:0.9rem;color:#fff;flex-shrink:0;
  }
  .profile-info { display:flex; flex-direction:column; gap:2px; overflow:hidden; }
  .profile-name {
    color:#111827;font-size:0.85rem;font-weight:600;line-height:1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:140px;
  }
  .profile-level { color:#6b7280;font-size:0.75rem;font-weight:500;line-height:1.2; }

  .nav-link {
    display:flex; align-items:center;
    padding-left:10px; padding-right:8px;
    max-width: calc(100% - 8px);
    border-radius:10px;
    transition: background-color 0.18s ease, color 0.18s ease, box-shadow 0.18s ease;
    color:#4b5563;
  }
  .nav-link .icon { min-width:42px; height:42px; border-radius:10px; background-color:#fff; }
  .nav-link:hover { background-color:#f3f4f6; color:#111827; }
  .nav-link.active { background-color:#e8f3ff; color:#111827 !important; box-shadow: inset 3px 0 0 #3a9fff; }

  .sidebar-toggle-btn {
    position:absolute; top:24px; right:16px;
    width:28px; height:28px;
    border-radius:6px; border:none;
    background:#f1f5f9;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; padding:0;
    z-index:1050;
    transition: all 0.2s ease;
  }
  .sidebar-toggle-btn i {
    font-size:12px; color:#64748b;
    transition: transform 0.25s ease, color 0.2s ease;
  }
  .sidebar-toggle-btn:hover { background-color:#e2e8f0; }
  .sidebar-toggle-btn:hover i { color:#334155; }

  body.sidebar-collapsed #sidenav-main { width:72px; }
  body.sidebar-collapsed .main-content { margin-left:90px !important; }
  body.sidebar-collapsed .nav-link-text,
  body.sidebar-collapsed .logo-text,
  body.sidebar-collapsed .logo-dot,
  body.sidebar-collapsed .profile-info { display:none !important; }
  body.sidebar-collapsed .navbar-nav .nav-link { justify-content:center; }
  body.sidebar-collapsed #sidenav-main .navbar-nav .nav-link { background:transparent !important; box-shadow:none !important; }
  body.sidebar-collapsed #sidenav-main .navbar-nav .nav-link .icon,
  body.sidebar-collapsed #sidenav-main .navbar-nav .nav-link .icon-shape { background:transparent !important; box-shadow:none !important; }
  body.sidebar-collapsed #sidenav-main .navbar-nav .nav-link.active .icon,
  body.sidebar-collapsed #sidenav-main .navbar-nav .nav-link.active .icon-shape {
    background:#d100a8 !important;
    border-radius:14px !important;
    box-shadow: 0 8px 16px rgba(0,0,0,0.25) !important;
  }
  body.sidebar-collapsed .profile-container {
    justify-content:center; padding:0.75rem 0; margin:0;
    background-color:transparent; box-shadow:none;
  }
  body.sidebar-collapsed .sidebar-toggle-btn i { transform: rotate(180deg); }
  body.sidebar-collapsed .sidebar-toggle-btn { right:22px; }

  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.4; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* -----------------------------------------
     MOBILE DRAWER (ONLY ADDITION)
     ----------------------------------------- */
  .site-sidenav-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(17, 24, 39, 0.50);
    z-index: 5000;
    display: none;
  }
  body.site-sidenav-open .site-sidenav-backdrop {
    display: block;
  }

  @media (max-width: 768px) {
    /* off-canvas */
    #sidenav-main {
      width: 85vw;
      max-width: 360px;
      transform: translateX(-110%);
      margin: 0 !important;
      left: 0 !important;
      top: 0 !important;
      border-radius: 0 !important;
      z-index: 5001 !important;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
    }
    body.site-sidenav-open #sidenav-main {
      transform: translateX(0);
    }

    /* never offset content on mobile */
    .main-content { margin-left: 0 !important; }

    /* hide desktop collapse button on mobile */
    #sidebar-toggle-btn { display: none !important; }

    /* ignore desktop collapsed rules on mobile */
    body.sidebar-collapsed #sidenav-main { width: 85vw; }
    body.sidebar-collapsed .nav-link-text,
    body.sidebar-collapsed .logo-text,
    body.sidebar-collapsed .logo-dot,
    body.sidebar-collapsed .profile-info { display: block !important; }
  }
    /* =========================================
   MOBILE DRAWER â€“ RESTORE SIDEBAR STYLES
   ========================================= */
@media (max-width: 768px) {

  /* Drawer container look */
  body.site-sidenav-open #sidenav-main {
    background: #ffffff !important;
    box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25) !important;
  }

  /* ðŸ”¥ THIS IS THE KEY FIX ðŸ”¥
     Override Bootstrap d-none when drawer is open */
  body.site-sidenav-open #sidenav-main .nav-link-text {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* Logo text + dot */
  body.site-sidenav-open #sidenav-main .logo-text,
  body.site-sidenav-open #sidenav-main .logo-dot {
    display: inline-block !important;
  }

  /* Profile info */
  body.site-sidenav-open #sidenav-main .profile-info {
    display: flex !important;
  }

  /* Ensure nav rows align like desktop */
  body.site-sidenav-open #sidenav-main .nav-link {
    justify-content: flex-start !important;
  }
}

</style>

<script>
(function () {
  function isMobile() {
    return window.matchMedia("(max-width: 768px)").matches;
  }

  function applySidebarState() {
    try {
      if (isMobile()) {
        // On mobile, we never keep the desktop collapsed state
        document.body.classList.remove('sidebar-collapsed');
        return;
      }
      var collapsed = localStorage.getItem('sidebarCollapsed') === '1';
      if (collapsed) document.body.classList.add('sidebar-collapsed');
      else document.body.classList.remove('sidebar-collapsed');
    } catch (e) {}
  }

  // Desktop collapse (your original)
  window.toggleSidebarCollapse = function () {
    if (isMobile()) return; // mobile uses drawer
    var body = document.body;
    var willCollapse = !body.classList.contains('sidebar-collapsed');
    if (willCollapse) body.classList.add('sidebar-collapsed');
    else body.classList.remove('sidebar-collapsed');
    try { localStorage.setItem('sidebarCollapsed', willCollapse ? '1' : '0'); } catch (e) {}
  };

  // Mobile drawer API (navbar should call this)
  window.openSiteSidenav = function () {
    if (!isMobile()) return;
    document.body.classList.add('site-sidenav-open');
    document.body.style.overflow = 'hidden';
  };
  window.closeSiteSidenav = function () {
    document.body.classList.remove('site-sidenav-open');
    document.body.style.overflow = '';
  };
  window.toggleSiteSidenav = function () {
    if (!isMobile()) return;
    if (document.body.classList.contains('site-sidenav-open')) window.closeSiteSidenav();
    else window.openSiteSidenav();
  };

  // Backdrop click closes
  document.addEventListener('DOMContentLoaded', function () {
    applySidebarState();
    var backdrop = document.getElementById('site-sidenav-backdrop');
    if (backdrop) backdrop.addEventListener('click', window.closeSiteSidenav);

    // close on ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') window.closeSiteSidenav();
    });

    // close drawer after clicking a nav link (mobile)
    var sidenav = document.getElementById('sidenav-main');
    if (sidenav) {
      sidenav.addEventListener('click', function (e) {
        var a = e.target.closest('a');
        if (a && isMobile()) window.closeSiteSidenav();
      });
    }
  });

  window.addEventListener('resize', function () {
    // If user rotates / resizes out of mobile, clean up
    if (!isMobile()) {
      window.closeSiteSidenav();
      applySidebarState();
    } else {
      document.body.classList.remove('sidebar-collapsed');
    }
  });
})();
</script>
